# 新真机配对和测试指南

## 第一步：在手机上启用无线调试

### 1.1 启用开发者选项
1. 打开手机的 **设置**
2. 找到 **关于手机** 或 **我的设备**
3. 连续点击 **版本号** 7次，直到提示"您已成为开发者"
4. 返回设置，找到 **开发者选项** 或 **系统** → **开发者选项**

### 1.2 启用无线调试
1. 进入 **开发者选项**
2. 找到 **无线调试** 或 **Wireless debugging**（Android 11+）
3. 打开 **无线调试** 开关
4. 如果提示需要位置权限，请允许

### 1.3 进入无线调试设置
1. 点击 **无线调试** 进入详细设置
2. 点击 **使用配对码配对设备** 或 **Pair device with pairing code**
3. 记录显示的 **配对码** 和 **IP地址:端口**

例如：
- 配对码：`123456`
- IP地址：`192.168.1.100:12345`

## 第二步：在电脑上配对设备

### 2.1 打开 PowerShell
在项目根目录 `D:\Tongxun` 打开 PowerShell

### 2.2 执行配对命令
```powershell
# 替换为你的配对码和IP地址
& "C:\Users\56466\AppData\Local\Android\Sdk\platform-tools\adb.exe" pair 192.168.1.100:12345
```

系统会提示输入配对码，输入手机上显示的配对码（如：`123456`）

### 2.3 验证配对结果
如果配对成功，会显示类似：
```
Successfully paired to 192.168.1.100:12345
```

## 第三步：连接设备

### 3.1 获取连接地址
配对成功后，手机会显示一个新的 **IP地址:端口**（与配对时的不同）

例如：
- 连接地址：`192.168.1.100:45678`

### 3.2 执行连接命令
```powershell
& "C:\Users\56466\AppData\Local\Android\Sdk\platform-tools\adb.exe" connect 192.168.1.100:45678
```

### 3.3 验证连接
```powershell
& "C:\Users\56466\AppData\Local\Android\Sdk\platform-tools\adb.exe" devices
```

应该能看到你的设备：
```
List of devices attached
192.168.1.100:45678      device
192.168.4.28:37157       device
emulator-5554   device
...
```

## 第四步：使用快速部署脚本安装应用

### 4.1 使用指定设备安装
```powershell
.\quick-deploy.ps1 -NoBuild -DeviceId "192.168.1.100:45678" -Launch
```

### 4.2 或者让脚本自动选择
如果有多个设备，脚本会提示选择：
```powershell
.\quick-deploy.ps1 -NoBuild -Launch
```

然后输入设备对应的序号。

## 第五步：测试语音消息功能

### 5.1 登录应用
1. 打开应用（如果使用 `-Launch` 参数会自动打开）
2. 使用账号登录

### 5.2 测试发送语音消息（发送方）
1. 进入任意聊天界面（单聊或群聊）
2. 点击语音按钮（麦克风图标）
3. 录制几秒语音（建议 2-5 秒）
4. 点击停止按钮
5. **立即点击语音消息播放**，验证是否能立即播放

### 5.3 测试接收语音消息（接收方）
1. 在另一个设备上登录另一个账号
2. 进入同一个聊天界面
3. 等待收到语音消息
4. 点击语音消息播放，验证是否能正常播放

### 5.4 验证播放逻辑
- **发送方**：应该能立即播放（使用本地录制文件）
- **接收方**：应该能正常播放（从服务器下载后播放）

## 第六步：查看日志（如遇问题）

### 6.1 过滤应用日志
```powershell
& "C:\Users\56466\AppData\Local\Android\Sdk\platform-tools\adb.exe" -s 192.168.1.100:45678 logcat -s ChatViewModel:V VoiceRecordDialog:V ChatActivity:V MessageRepositoryImpl:V UploadRepository:V AudioPlayer:V *:E
```

### 6.2 或者使用 PowerShell 过滤
```powershell
& "C:\Users\56466\AppData\Local\Android\Sdk\platform-tools\adb.exe" -s 192.168.1.100:45678 logcat | Select-String -Pattern "ChatViewModel|VoiceRecordDialog|ChatActivity|AudioPlayer|UploadRepository"
```

## 常见问题

### Q1: 配对失败
- 确保手机和电脑在同一个 Wi-Fi 网络
- 检查防火墙是否阻止了连接
- 尝试关闭并重新打开无线调试

### Q2: 连接后显示 "unauthorized"
- 在手机上查看是否有授权提示，点击"允许"
- 尝试断开重连：`adb disconnect` 然后重新 `adb connect`

### Q3: 设备列表中没有新设备
- 检查 IP 地址和端口是否正确
- 确保手机上的无线调试仍然开启
- 尝试重新配对和连接

### Q4: 语音消息无法播放
- 检查服务器日志：`ssh root@47.116.197.230` → `pm2 logs tongxun-server`
- 检查客户端日志（使用上面的 logcat 命令）
- 确认文件上传是否成功

## 快速命令参考

```powershell
# 查看所有设备
adb devices

# 配对设备（替换 IP:PORT 和配对码）
adb pair 192.168.1.100:12345

# 连接设备（替换为连接地址）
adb connect 192.168.1.100:45678

# 断开设备
adb disconnect 192.168.1.100:45678

# 安装 APK 到指定设备
.\quick-deploy.ps1 -NoBuild -DeviceId "192.168.1.100:45678" -Launch

# 查看日志
adb -s 192.168.1.100:45678 logcat -s ChatViewModel VoiceRecordDialog ChatActivity
```


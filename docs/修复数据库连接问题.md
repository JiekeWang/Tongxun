# ä¿®å¤æ•°æ®åº“è¿žæŽ¥é—®é¢˜

## ðŸ” é—®é¢˜åˆ†æž

é”™è¯¯ä¿¡æ¯ï¼š`Access denied for user 'root'@'localhost' (using password: YES)`

**åŽŸå› **ï¼šæœåŠ¡æ­£åœ¨å°è¯•ä½¿ç”¨ `root` ç”¨æˆ·è¿žæŽ¥æ•°æ®åº“ï¼Œä½†åº”è¯¥ä½¿ç”¨ `wangjia` ç”¨æˆ·ã€‚

---

## ðŸš€ å¿«é€Ÿä¿®å¤æ­¥éª¤

### 1. æ£€æŸ¥ .env æ–‡ä»¶

```bash
cd /var/www/tongxun/server
cat .env
```

**åº”è¯¥çœ‹åˆ°ï¼š**
```env
DB_USER=wangjia
DB_PASSWORD=qazQAZ123
DB_NAME=tongxun
```

**å¦‚æžœçœ‹åˆ° `DB_USER=root`ï¼Œéœ€è¦ä¿®æ”¹ã€‚**

---

### 2. ä¿®å¤ .env æ–‡ä»¶

```bash
# ç¼–è¾‘ .env æ–‡ä»¶
nano .env
```

**ç¡®ä¿é…ç½®å¦‚ä¸‹ï¼š**
```env
NODE_ENV=production
PORT=3000

DB_HOST=localhost
DB_PORT=3306
DB_USER=wangjia
DB_PASSWORD=qazQAZ123
DB_NAME=tongxun

REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

JWT_SECRET=your-very-secure-secret-key-change-this-in-production-min-32-chars
JWT_EXPIRES_IN=7d

WS_PATH=/ws
LOG_LEVEL=info
LOG_DIR=./logs
```

**ä¿å­˜ï¼š** `Ctrl+X` â†’ `Y` â†’ `Enter`

---

### 3. éªŒè¯æ•°æ®åº“ç”¨æˆ·

```bash
# æµ‹è¯• wangjia ç”¨æˆ·æ˜¯å¦å¯ä»¥ç™»å½•
mysql -u wangjia -p
# è¾“å…¥å¯†ç ï¼šqazQAZ123

# åœ¨MySQLä¸­ï¼š
USE tongxun;
SHOW TABLES;
EXIT;
```

**å¦‚æžœæ— æ³•ç™»å½•ï¼Œéœ€è¦åˆ›å»ºç”¨æˆ·ï¼š**
```bash
mysql -u root -p
```

```sql
CREATE USER IF NOT EXISTS 'wangjia'@'localhost' IDENTIFIED BY 'qazQAZ123';
GRANT ALL PRIVILEGES ON tongxun.* TO 'wangjia'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

---

### 4. é‡å¯æœåŠ¡

```bash
pm2 restart tongxun-server
```

---

### 5. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤

```bash
pm2 logs tongxun-server --lines 30
```

**åº”è¯¥çœ‹åˆ°ï¼š**
- `æ•°æ®åº“è¿žæŽ¥æˆåŠŸ`
- `æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ 3000`

---

## ðŸ”§ ä¸€é”®ä¿®å¤å‘½ä»¤

```bash
cd /var/www/tongxun/server && \
cat > .env << 'EOF'
NODE_ENV=production
PORT=3000
DB_HOST=localhost
DB_PORT=3306
DB_USER=wangjia
DB_PASSWORD=qazQAZ123
DB_NAME=tongxun
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
JWT_SECRET=your-very-secure-secret-key-change-this-in-production-min-32-chars
JWT_EXPIRES_IN=7d
WS_PATH=/ws
LOG_LEVEL=info
LOG_DIR=./logs
EOF
chmod 600 .env && \
pm2 restart tongxun-server && \
sleep 2 && \
pm2 logs tongxun-server --lines 20
```

---

## âœ… éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
pm2 list
# åº”è¯¥æ˜¾ç¤º online
```

### 2. æ£€æŸ¥æ—¥å¿—

```bash
pm2 logs tongxun-server --lines 20
# åº”è¯¥çœ‹åˆ° "æ•°æ®åº“è¿žæŽ¥æˆåŠŸ"
```

### 3. æµ‹è¯•API

```bash
curl http://localhost:3000/api/health
# åº”è¯¥è¿”å›žï¼š{"status":"ok","timestamp":"..."}
```

---

## ðŸ†˜ å¦‚æžœä»ç„¶å¤±è´¥

### æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·æ˜¯å¦å­˜åœ¨

```bash
mysql -u root -p
```

```sql
-- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
SELECT user, host FROM mysql.user WHERE user='wangjia';

-- å¦‚æžœä¸å­˜åœ¨ï¼Œåˆ›å»ºç”¨æˆ·
CREATE USER 'wangjia'@'localhost' IDENTIFIED BY 'qazQAZ123';
GRANT ALL PRIVILEGES ON tongxun.* TO 'wangjia'@'localhost';
FLUSH PRIVILEGES;

-- éªŒè¯æƒé™
SHOW GRANTS FOR 'wangjia'@'localhost';
EXIT;
```

### æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨

```sql
-- åœ¨MySQLä¸­
SHOW DATABASES LIKE 'tongxun';

-- å¦‚æžœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ•°æ®åº“
CREATE DATABASE tongxun CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EXIT;
```

### æ£€æŸ¥ .env æ–‡ä»¶æƒé™

```bash
ls -la /var/www/tongxun/server/.env
# åº”è¯¥æ˜¾ç¤ºï¼š-rw------- (600æƒé™)

# å¦‚æžœæƒé™ä¸å¯¹ï¼Œä¿®å¤ï¼š
chmod 600 /var/www/tongxun/server/.env
```

---

## ðŸ“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¿˜æ˜¯ä½¿ç”¨ root ç”¨æˆ·ï¼Ÿ

**A:** å¯èƒ½æ˜¯ï¼š
1. `.env` æ–‡ä»¶æ²¡æœ‰è¢«è¯»å–ï¼ˆæ£€æŸ¥æ–‡ä»¶è·¯å¾„ï¼‰
2. PM2 ç¼“å­˜äº†æ—§é…ç½®ï¼ˆéœ€è¦é‡å¯ï¼‰
3. `ecosystem.config.js` ä¸­ç¡¬ç¼–ç äº†é…ç½®

### Q2: å¦‚ä½•ç¡®è®¤ .env æ–‡ä»¶è¢«è¯»å–ï¼Ÿ

**A:** åœ¨ `src/index.js` ä¸­æ·»åŠ æ—¥å¿—ï¼š
```javascript
console.log('DB_USER:', process.env.DB_USER);
console.log('DB_NAME:', process.env.DB_NAME);
```

### Q3: PM2 çŽ¯å¢ƒå˜é‡é—®é¢˜

**A:** å¦‚æžœ PM2 æ²¡æœ‰è¯»å– `.env`ï¼Œå¯ä»¥ï¼š
```bash
# æ–¹æ³•1ï¼šåœ¨ ecosystem.config.js ä¸­æŒ‡å®š env_file
# æ–¹æ³•2ï¼šä½¿ç”¨ pm2 start --update-env
pm2 restart tongxun-server --update-env
```


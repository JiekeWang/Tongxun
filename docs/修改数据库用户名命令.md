# 修改服务器数据库用户名命令

## 问题
服务器上的 `.env` 文件中 `DB_USER=root`，应该改为 `DB_USER=wangjia`

## 修改命令

### 方法1：使用 sed 命令（推荐）

```bash
cd /var/www/tongxun/server
sed -i 's/^DB_USER=root$/DB_USER=wangjia/' .env
```

### 方法2：使用 sed 命令（更安全，匹配整行）

```bash
cd /var/www/tongxun/server
sed -i 's/^DB_USER=root/DB_USER=wangjia/' .env
```

### 方法3：手动编辑

```bash
cd /var/www/tongxun/server
nano .env
# 找到 DB_USER=root，改为 DB_USER=wangjia
# 按 Ctrl+X，输入 Y 确认，回车保存
```

## 验证修改

### 1. 查看修改后的配置
```bash
grep DB_USER /var/www/tongxun/server/.env
```

应该显示：
```
DB_USER=wangjia
```

### 2. 测试数据库连接
```bash
mysql -u wangjia -pqazQAZ123 -e "SELECT '连接成功' AS status;" tongxun
```

### 3. 重启服务
```bash
cd /var/www/tongxun/server

# 如果使用 PM2
pm2 restart tongxun --update-env

# 或者如果使用 systemd
systemctl restart tongxun
```

### 4. 查看日志确认
```bash
# 如果使用 PM2
pm2 logs tongxun --lines 20

# 应该看到：
# 数据库连接成功
```

## 检查项目代码

项目代码中：
- ✅ `server/src/config/database.js` 使用 `process.env.DB_USER || 'root'`（默认值是 root，但会从环境变量读取）
- ✅ `server/start-server.sh` 中配置的是 `DB_USER=wangjia`
- ✅ `server/init-database.sql` 中创建的是 `wangjia` 用户

**结论**：代码没有问题，只需要修改服务器上的 `.env` 文件即可。

## 完整操作步骤

```bash
# 1. 进入服务器目录
cd /var/www/tongxun/server

# 2. 备份 .env 文件（可选）
cp .env .env.backup

# 3. 修改 DB_USER
sed -i 's/^DB_USER=root$/DB_USER=wangjia/' .env

# 4. 验证修改
grep DB_USER .env

# 5. 测试数据库连接
mysql -u wangjia -pqazQAZ123 -e "SELECT '连接成功' AS status;" tongxun

# 6. 重启服务
pm2 restart tongxun --update-env

# 7. 查看日志
pm2 logs tongxun --lines 20
```

## 注意事项

1. **确保 wangjia 用户存在**：
   ```bash
   mysql -u root -p
   SELECT User, Host FROM mysql.user WHERE User = 'wangjia';
   ```

2. **如果用户不存在，创建用户**：
   ```sql
   CREATE USER IF NOT EXISTS 'wangjia'@'localhost' IDENTIFIED BY 'qazQAZ123';
   GRANT ALL PRIVILEGES ON tongxun.* TO 'wangjia'@'localhost';
   FLUSH PRIVILEGES;
   ```

3. **确保用户有权限**：
   ```sql
   SHOW GRANTS FOR 'wangjia'@'localhost';
   ```


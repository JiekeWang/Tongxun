# 外部访问问题排查

## 🔍 问题：服务器本地可以访问，但外部无法访问

### 可能原因：
1. **阿里云安全组未开放3000端口**（最常见）
2. **服务只监听localhost，未监听0.0.0.0**
3. **域名解析问题**
4. **防火墙规则问题**

---

## 🚀 排查步骤

### 1. 检查服务监听地址

在服务器上执行：

```bash
# 检查服务监听地址
ss -tlnp | grep 3000
# 或
netstat -tlnp | grep 3000
```

**应该看到：**
```
LISTEN 0 511 *:3000 *:*
```
或
```
LISTEN 0 511 0.0.0.0:3000
```

**如果看到 `127.0.0.1:3000`，说明只监听本地，需要修改代码。**

---

### 2. 检查阿里云安全组（最重要）

1. 登录阿里云控制台
2. 进入 **ECS** → **实例** → 选择你的实例
3. 点击 **安全组** → **配置规则**
4. 点击 **入方向** → **添加安全组规则**
5. 配置：
   - **端口范围**：`3000/3000`
   - **授权对象**：`0.0.0.0/0`（允许所有IP，或限制为你的IP）
   - **协议类型**：`TCP`
   - **描述**：`通讯服务器端口`
6. 点击 **保存**

---

### 3. 检查域名解析

在本地电脑（Windows PowerShell）执行：

```powershell
# 检查域名解析
ping zhihome.com.cn
# 或
nslookup zhihome.com.cn
```

**应该返回：** `47.116.197.230`

**如果返回其他IP或无法解析：**
- 登录域名管理后台
- 添加A记录：
  - 主机记录：`@` 或 `www`
  - 记录类型：`A`
  - 记录值：`47.116.197.230`
  - TTL：`600`

---

### 4. 测试IP直接访问

在本地电脑测试：

```powershell
# 测试IP访问（绕过域名）
curl http://47.116.197.230:3000/api/health
```

**如果IP可以访问，但域名不行：**
- 域名解析问题，需要配置DNS

**如果IP也无法访问：**
- 安全组未配置，需要添加安全组规则

---

### 5. 检查服务器防火墙

在服务器上执行：

```bash
# 检查防火墙状态
systemctl status firewalld

# 检查已开放端口
firewall-cmd --list-ports

# 如果3000端口不在列表中，添加它
firewall-cmd --permanent --add-port=3000/tcp
firewall-cmd --reload

# 验证
firewall-cmd --list-ports
```

---

## 🔧 修复服务监听地址（如果需要）

如果服务只监听 `127.0.0.1`，需要修改代码：

**文件：** `server/src/index.js`

**找到：**
```javascript
server.listen(PORT, () => {
```

**改为：**
```javascript
server.listen(PORT, '0.0.0.0', () => {
```

**然后重启服务：**
```bash
pm2 restart tongxun-server
```

---

## ✅ 完整验证流程

### 在服务器上：

```bash
# 1. 检查监听地址
ss -tlnp | grep 3000

# 2. 检查防火墙
firewall-cmd --list-ports

# 3. 测试本地访问
curl http://localhost:3000/api/health
```

### 在本地电脑：

```powershell
# 1. 检查域名解析
ping zhihome.com.cn

# 2. 测试IP访问
curl http://47.116.197.230:3000/api/health

# 3. 测试域名访问
curl http://zhihome.com.cn:3000/api/health
```

---

## 🆘 常见问题

### Q1: 服务器可以访问，但外部无法访问

**A:** 99%是阿里云安全组未配置。检查并添加3000端口的入站规则。

### Q2: IP可以访问，但域名不行

**A:** 域名解析问题。检查DNS配置，确保A记录指向 `47.116.197.230`。

### Q3: 连接超时

**A:** 
1. 检查安全组
2. 检查防火墙
3. 检查服务是否运行：`pm2 list`

### Q4: 连接被拒绝

**A:** 
1. 检查服务监听地址（应该是 `0.0.0.0:3000`）
2. 检查防火墙规则
3. 检查安全组规则

---

## 📝 快速检查清单

- [ ] 服务正在运行：`pm2 list` 显示 `online`
- [ ] 服务监听 `0.0.0.0:3000`：`ss -tlnp | grep 3000`
- [ ] 防火墙已开放3000端口：`firewall-cmd --list-ports`
- [ ] 阿里云安全组已配置3000端口
- [ ] 域名解析正确：`ping zhihome.com.cn` 返回 `47.116.197.230`
- [ ] 本地可以访问：`curl http://localhost:3000/api/health`
- [ ] IP可以访问：`curl http://47.116.197.230:3000/api/health`
- [ ] 域名可以访问：`curl http://zhihome.com.cn:3000/api/health`


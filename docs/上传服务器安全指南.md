# æœåŠ¡å™¨ä¸Šä¼ å®‰å…¨æŒ‡å—

## âš ï¸ é—®é¢˜è¯´æ˜Ž

æ¯æ¬¡ä½¿ç”¨ `scp -r server` ä¸Šä¼ ä»£ç æ—¶ï¼Œä¼šè¦†ç›–æœåŠ¡å™¨ä¸Šçš„ `.env` æ–‡ä»¶ï¼Œå¯¼è‡´æ•°æ®åº“é…ç½®ä¸¢å¤±ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨å®‰å…¨ä¸Šä¼ è„šæœ¬ï¼ˆæŽ¨èï¼‰

ä½¿ç”¨æä¾›çš„ `upload-server-safe.ps1` è„šæœ¬ï¼Œè‡ªåŠ¨æŽ’é™¤ `.env` ç­‰æ•æ„Ÿæ–‡ä»¶ï¼š

```powershell
# åœ¨ Windows PowerShell ä¸­æ‰§è¡Œ
.\upload-server-safe.ps1 -ServerIP "your-server-ip"

# ç¤ºä¾‹
.\upload-server-safe.ps1 -ServerIP "47.116.197.230"
```

**è„šæœ¬ç‰¹ç‚¹ï¼š**
- âœ… è‡ªåŠ¨æŽ’é™¤ `.env` æ–‡ä»¶
- âœ… æŽ’é™¤ `node_modules`ã€`logs` ç­‰ä¸éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶
- âœ… æ˜¾ç¤ºä¸Šä¼ æ–‡ä»¶å¤§å°
- âœ… æä¾›æœåŠ¡å™¨ç«¯æ‰§è¡Œå‘½ä»¤

---

### æ–¹æ¡ˆ2ï¼šåœ¨æœåŠ¡å™¨ä¸Šä¿æŠ¤ .env æ–‡ä»¶

**é¦–æ¬¡éƒ¨ç½²åŽï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š**

```bash
# 1. è¿›å…¥æœåŠ¡å™¨ç›®å½•
cd /var/www/tongxun/server

# 2. ä¿æŠ¤ .env æ–‡ä»¶
chmod +x protect-env.sh
./protect-env.sh
```

**å¦‚æžœ .env è¢«è¦†ç›–ï¼Œå¿«é€Ÿæ¢å¤ï¼š**

```bash
# æ¢å¤ .env æ–‡ä»¶
chmod +x restore-env.sh
./restore-env.sh

# å¦‚æžœæ˜¯ä»Žå¤‡ä»½æ¢å¤ï¼Œæ£€æŸ¥é…ç½®
cat /var/www/tongxun/server/.env | grep DB_USER
# åº”è¯¥æ˜¾ç¤º: DB_USER=root
```

---

### æ–¹æ¡ˆ3ï¼šæ‰‹åŠ¨æŽ’é™¤ .env æ–‡ä»¶ä¸Šä¼ 

**ä½¿ç”¨ rsyncï¼ˆæŽ¨èï¼Œéœ€è¦å®‰è£… rsyncï¼‰ï¼š**

```bash
# åœ¨ Windows ä¸Šï¼ˆéœ€è¦ Git Bash æˆ– WSLï¼‰
rsync -avz --exclude='.env' \
          --exclude='node_modules' \
          --exclude='logs' \
          --exclude='*.log' \
          server/ root@your-server-ip:/var/www/tongxun/server/
```

**æˆ–ä½¿ç”¨ tar æŽ’é™¤æ–‡ä»¶ï¼š**

```powershell
# åœ¨ PowerShell ä¸­
cd E:\Tongxun

# åˆ›å»ºæŽ’é™¤åˆ—è¡¨æ–‡ä»¶
@"
.env
node_modules/
logs/
*.log
.env.backup
"@ | Out-File -Encoding utf8 exclude.txt

# åŽ‹ç¼©ï¼ˆæŽ’é™¤ .envï¼‰
tar --exclude-from=exclude.txt -czf server.tar.gz server/

# ä¸Šä¼ 
scp server.tar.gz root@your-server-ip:/tmp/

# åœ¨æœåŠ¡å™¨ä¸Šè§£åŽ‹ï¼ˆä¸ä¼šè¦†ç›–å·²å­˜åœ¨çš„ .envï¼‰
ssh root@your-server-ip
cd /var/www/tongxun/server
tar -xzf /tmp/server.tar.gz
rm -f /tmp/server.tar.gz
```

---

## ðŸ“‹ æ ‡å‡†ä¸Šä¼ æµç¨‹

### 1. ä¸Šä¼ ä»£ç ï¼ˆä½¿ç”¨å®‰å…¨è„šæœ¬ï¼‰

```powershell
.\upload-server-safe.ps1 -ServerIP "your-server-ip"
```

### 2. åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ

```bash
ssh root@your-server-ip
cd /var/www/tongxun/server

# è§£åŽ‹ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆå¦‚æžœæ˜¯åŽ‹ç¼©åŒ…ï¼‰
tar -xzf /tmp/server_upload_*.tar.gz
rm -f /tmp/server_upload_*.tar.gz

# æ£€æŸ¥ .env æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”é…ç½®æ­£ç¡®
cat .env | grep DB_USER
# åº”è¯¥æ˜¾ç¤º: DB_USER=root

# å¦‚æžœ .env ä¸¢å¤±æˆ–é…ç½®é”™è¯¯ï¼Œæ¢å¤å®ƒ
./restore-env.sh

# å®‰è£…ä¾èµ–ï¼ˆå¦‚æžœæœ‰æ–°åŒ…ï¼‰
npm install

# é‡å¯æœåŠ¡
pm2 restart tongxun-server

# æŸ¥çœ‹æ—¥å¿—ç¡®è®¤
pm2 logs tongxun-server --lines 50
```

---

## ðŸ”’ æœ€ä½³å®žè·µ

### 1. å®šæœŸå¤‡ä»½ .env æ–‡ä»¶

```bash
# åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºå¤‡ä»½
cp /var/www/tongxun/server/.env /var/www/tongxun/server/.env.backup.$(date +%Y%m%d)
```

### 2. ä½¿ç”¨çŽ¯å¢ƒå˜é‡ï¼ˆé«˜çº§ï¼‰

å¦‚æžœä½¿ç”¨ Docker æˆ– Kubernetesï¼Œå»ºè®®ä½¿ç”¨çŽ¯å¢ƒå˜é‡è€Œä¸æ˜¯ `.env` æ–‡ä»¶ã€‚

### 3. ç‰ˆæœ¬æŽ§åˆ¶

- âœ… `.env.example` - æäº¤åˆ°ç‰ˆæœ¬æŽ§åˆ¶ï¼ˆåŒ…å«ç¤ºä¾‹é…ç½®ï¼‰
- âŒ `.env` - **æ°¸è¿œä¸è¦æäº¤**ï¼ˆå·²åœ¨ `.gitignore` ä¸­ï¼‰

---

## ðŸš¨ ç´§æ€¥æ¢å¤

å¦‚æžœ `.env` æ–‡ä»¶è¢«è¦†ç›–ï¼Œå¿«é€Ÿæ¢å¤ï¼š

```bash
# æ–¹æ³•1: ä»Žå¤‡ä»½æ¢å¤
cp /var/www/tongxun/server/.env.backup /var/www/tongxun/server/.env

# æ–¹æ³•2: æ‰‹åŠ¨é‡æ–°é…ç½®ï¼ˆå¦‚æžœçŸ¥é“é…ç½®ï¼‰
cat > /var/www/tongxun/server/.env << EOF
PORT=3000
JWT_SECRET=your-secret-key
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=qazQAZ123
DB_NAME=tongxun
REDIS_HOST=localhost
REDIS_PORT=6379
WS_PATH=/ws
EOF

# è®¾ç½®æƒé™
chmod 600 /var/www/tongxun/server/.env

# é‡å¯æœåŠ¡
pm2 restart tongxun-server
```

---

## ðŸ“ æ£€æŸ¥æ¸…å•

ä¸Šä¼ ä»£ç åŽï¼ŒåŠ¡å¿…æ£€æŸ¥ï¼š

- [ ] `.env` æ–‡ä»¶å­˜åœ¨
- [ ] `DB_USER` é…ç½®æ­£ç¡®ï¼ˆåº”è¯¥æ˜¯ `root`ï¼‰
- [ ] `DB_PASSWORD` é…ç½®æ­£ç¡®
- [ ] `DB_NAME` é…ç½®æ­£ç¡®ï¼ˆåº”è¯¥æ˜¯ `tongxun`ï¼‰
- [ ] æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] æ•°æ®åº“è¿žæŽ¥æˆåŠŸ

---

## ðŸ’¡ è‡ªåŠ¨åŒ–è„šæœ¬

åˆ›å»ºæœåŠ¡å™¨ç«¯è‡ªåŠ¨æ£€æŸ¥å’Œæ¢å¤è„šæœ¬ï¼š

```bash
#!/bin/bash
# /var/www/tongxun/server/check-and-restore-env.sh

ENV_FILE="/var/www/tongxun/server/.env"

if [ ! -f "$ENV_FILE" ]; then
    echo "âŒ .env æ–‡ä»¶ä¸¢å¤±ï¼Œæ­£åœ¨æ¢å¤..."
    /var/www/tongxun/server/restore-env.sh
    pm2 restart tongxun-server
elif ! grep -q "DB_USER=root" "$ENV_FILE"; then
    echo "âš ï¸  DB_USER é…ç½®å¯èƒ½ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥ï¼š"
    grep DB_USER "$ENV_FILE"
fi
```

å°†è¯¥è„šæœ¬æ·»åŠ åˆ° PM2 çš„å¯åŠ¨åŽé’©å­ï¼Œæˆ–å®šæœŸæ‰§è¡Œã€‚


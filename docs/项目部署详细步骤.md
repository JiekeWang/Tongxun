# 项目部署详细步骤

## 📦 第一步：上传项目代码到服务器

### 方法1：使用SCP上传（推荐，从本地Windows）

```bash
# 在本地Windows PowerShell或CMD中执行
# 确保在项目根目录（E:\Tongxun）

# 上传server目录到服务器
scp -r server root@your-server-ip:/var/www/tongxun/

# 示例（替换为你的服务器IP）
# scp -r server root@47.xxx.xxx.xxx:/var/www/tongxun/
```

### 方法2：使用Git（如果代码在Git仓库）

```bash
# 在服务器上执行
mkdir -p /var/www/tongxun
cd /var/www/tongxun

# 克隆项目（如果有Git仓库）
git clone your-repo-url .

# 或只克隆server目录
git clone your-repo-url temp
mv temp/server .
rm -rf temp
```

### 方法3：使用FTP/SFTP工具

1. 使用 **FileZilla**、**WinSCP** 等工具
2. 连接到服务器：`sftp://root@your-server-ip`
3. 上传 `server` 目录到 `/var/www/tongxun/`

### 方法4：使用tar压缩上传（适合大文件）

```bash
# 在本地Windows执行（PowerShell）
# 压缩server目录
tar -czf server.tar.gz server

# 上传压缩包
scp server.tar.gz root@your-server-ip:/tmp/

# 在服务器上解压
ssh root@your-server-ip
cd /var/www/tongxun
tar -xzf /tmp/server.tar.gz
mv server/* .
rm -rf server
```

### 验证上传

```bash
# 在服务器上检查
ls -la /var/www/tongxun/server/
# 应该看到：package.json, src/, node_modules/ 等文件
```

---

## 📦 第二步：安装项目依赖

```bash
# 1. 进入项目目录
cd /var/www/tongxun/server

# 2. 检查Node.js版本（确保已安装）
node -v
npm -v
# 应该显示 v18.x 和 9.x+

# 3. 安装依赖
npm install

# 4. 等待安装完成（可能需要几分钟）
# 安装完成后会看到类似输出：
# added 234 packages in 2m
```

### 如果npm install失败

```bash
# 清除npm缓存
npm cache clean --force

# 使用国内镜像（可选，加速下载）
npm config set registry https://registry.npmmirror.com

# 重新安装
npm install

# 安装完成后恢复官方源（可选）
npm config set registry https://registry.npmjs.org
```

### 验证依赖安装

```bash
# 检查node_modules目录
ls -la node_modules/ | head -20

# 检查关键依赖
npm list express socket.io mysql2 redis
```

---

## ⚙️ 第三步：配置环境变量

### 3.1 创建.env文件

```bash
# 进入项目目录
cd /var/www/tongxun/server

# 检查是否有.env.example文件
ls -la .env*

# 如果有.env.example，复制它
cp .env.example .env

# 如果没有.env.example，创建新文件
touch .env
```

### 3.2 编辑.env文件

```bash
# 使用nano编辑器（简单易用）
nano .env

# 或使用vi编辑器
vi .env
```

### 3.3 .env文件配置内容

```env
# 服务器配置
NODE_ENV=production
PORT=3000

# 数据库配置（使用之前设置的MySQL密码）
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_mysql_password_here
DB_NAME=tongxun

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT配置（必须修改为强密码）
JWT_SECRET=your-very-secure-secret-key-change-this-in-production-min-32-chars
JWT_EXPIRES_IN=7d

# WebSocket配置
WS_PATH=/ws

# 日志配置
LOG_LEVEL=info
LOG_DIR=./logs
```

### 3.4 保存文件

**使用nano：**
- 编辑完成后按 `Ctrl + X`
- 按 `Y` 确认保存
- 按 `Enter` 确认文件名

**使用vi：**
- 按 `i` 进入编辑模式
- 编辑完成后按 `Esc`
- 输入 `:wq` 保存并退出

### 3.5 验证配置

```bash
# 检查.env文件内容（不显示密码）
cat .env | grep -v PASSWORD

# 检查文件权限（确保安全）
ls -la .env
# 应该只有root可读写
chmod 600 .env
```

---

## 🗄️ 第四步：创建数据库

### 4.1 登录MySQL

```bash
# 使用root用户登录
mysql -u root -p

# 输入之前设置的MySQL密码
```

### 4.2 创建数据库

```sql
-- 创建数据库（使用utf8mb4字符集）
CREATE DATABASE tongxun CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 查看数据库
SHOW DATABASES;

-- 应该看到tongxun数据库
```

### 4.3 创建专用数据库用户（可选，更安全）

```sql
-- 创建用户
CREATE USER 'tongxun_user'@'localhost' IDENTIFIED BY 'your_strong_password';

-- 授权
GRANT ALL PRIVILEGES ON tongxun.* TO 'tongxun_user'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;

-- 查看用户
SELECT User, Host FROM mysql.user WHERE User='tongxun_user';

-- 退出MySQL
EXIT;
```

### 4.4 如果使用专用用户，更新.env

```bash
# 编辑.env文件
nano /var/www/tongxun/server/.env

# 修改数据库配置
# DB_USER=tongxun_user
# DB_PASSWORD=your_strong_password
```

### 4.5 验证数据库连接

```bash
# 测试数据库连接
cd /var/www/tongxun/server
node -e "require('dotenv').config(); const mysql = require('mysql2/promise'); (async () => { try { const conn = await mysql.createConnection({host: process.env.DB_HOST, user: process.env.DB_USER, password: process.env.DB_PASSWORD, database: process.env.DB_NAME}); console.log('数据库连接成功！'); await conn.end(); } catch(e) { console.error('数据库连接失败:', e.message); } })()"
```

---

## 🚀 第五步：启动服务

### 5.1 检查PM2是否安装

```bash
# 检查PM2
pm2 -v

# 如果未安装，安装它
npm install -g pm2
```

### 5.2 检查ecosystem.config.js文件

```bash
# 进入项目目录
cd /var/www/tongxun/server

# 检查PM2配置文件
ls -la ecosystem.config.js

# 如果没有，创建它
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'tongxun-server',
    script: 'src/index.js',
    instances: 1,
    exec_mode: 'fork',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/pm2-error.log',
    out_file: './logs/pm2-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    min_uptime: '10s',
    max_restarts: 10,
    restart_delay: 4000
  }]
};
EOF
```

### 5.3 确保logs目录存在

```bash
# 创建logs目录
mkdir -p /var/www/tongxun/server/logs

# 检查权限
ls -la logs/
```

### 5.4 启动服务

```bash
# 进入项目目录
cd /var/www/tongxun/server

# 使用PM2启动
pm2 start ecosystem.config.js

# 或直接启动
pm2 start src/index.js --name tongxun-server
```

### 5.5 查看服务状态

```bash
# 查看PM2进程列表
pm2 list

# 应该看到：
# ┌─────┬──────────────────┬─────────┬─────────┬──────────┐
# │ id  │ name              │ status  │ restart │ uptime   │
# ├─────┼──────────────────┼─────────┼─────────┼──────────┤
# │ 0   │ tongxun-server    │ online  │ 0       │ 5s       │
# └─────┴──────────────────┴─────────┴─────────┴──────────┘

# 查看日志
pm2 logs tongxun-server

# 查看详细信息
pm2 show tongxun-server
```

### 5.6 保存PM2配置

```bash
# 保存当前PM2进程列表
pm2 save

# 设置开机自启
pm2 startup

# 执行输出的命令（通常是systemd相关）
# 例如：sudo env PATH=$PATH:/root/.nvm/versions/node/v18.x.x/bin pm2 startup systemd -u root --hp /root
```

### 5.7 测试服务

```bash
# 测试本地访问
curl http://localhost:3000/api/health
# 或
curl http://localhost:3000/

# 测试公网访问（替换为你的服务器IP）
curl http://your-server-ip:3000/api/health

# 检查端口监听
netstat -tulpn | grep 3000
# 或
ss -tulpn | grep 3000
```

---

## ✅ 验证部署

### 检查清单

```bash
# 1. 检查服务运行状态
pm2 list
systemctl status mysqld
systemctl status redis

# 2. 检查端口监听
netstat -tulpn | grep -E '3000|3306|6379'

# 3. 检查日志
pm2 logs tongxun-server --lines 50
tail -f /var/www/tongxun/server/logs/combined.log

# 4. 测试API
curl http://localhost:3000/api/health

# 5. 检查数据库连接
mysql -u root -p -e "USE tongxun; SHOW TABLES;"

# 6. 检查Redis连接
redis-cli ping
```

---

## 🔧 常用PM2命令

```bash
# 查看所有进程
pm2 list

# 查看日志
pm2 logs tongxun-server
pm2 logs tongxun-server --lines 100  # 查看最近100行

# 重启服务
pm2 restart tongxun-server

# 停止服务
pm2 stop tongxun-server

# 删除服务
pm2 delete tongxun-server

# 监控面板
pm2 monit

# 查看详细信息
pm2 show tongxun-server

# 重新加载（零停机重启）
pm2 reload tongxun-server
```

---

## 🐛 故障排查

### 服务无法启动

```bash
# 查看PM2日志
pm2 logs tongxun-server --err

# 查看应用日志
tail -f /var/www/tongxun/server/logs/combined.log
tail -f /var/www/tongxun/server/logs/error.log

# 手动测试启动
cd /var/www/tongxun/server
node src/index.js
# 查看错误信息
```

### 数据库连接失败

```bash
# 检查MySQL是否运行
systemctl status mysqld

# 测试数据库连接
mysql -u root -p -e "SHOW DATABASES;"

# 检查.env配置
cat /var/www/tongxun/server/.env | grep DB_
```

### 端口被占用

```bash
# 查看端口占用
lsof -i :3000
# 或
netstat -tulpn | grep 3000

# 杀死占用进程
kill -9 <PID>
```

---

## 📝 下一步：配置Nginx和域名

服务启动成功后，可以：
1. 配置Nginx反向代理
2. 配置SSL证书（HTTPS）
3. 修改Android客户端BASE_URL
4. 测试完整功能

详细步骤请参考 `阿里云ECS部署指南.md`


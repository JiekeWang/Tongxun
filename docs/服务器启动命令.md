# æœåŠ¡å™¨å¯åŠ¨å‘½ä»¤

## ğŸš€ å¿«é€Ÿå¯åŠ¨ï¼ˆæ¨èï¼‰

### æ–¹æ³•1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬

```bash
# 1. ä¸Šä¼ å¯åŠ¨è„šæœ¬åˆ°æœåŠ¡å™¨ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
# ä»æœ¬åœ°æ‰§è¡Œï¼š
scp server/start-server.sh root@47.116.197.230:/var/www/tongxun/server/

# 2. SSHç™»å½•æœåŠ¡å™¨
ssh root@47.116.197.230

# 3. ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x /var/www/tongxun/server/start-server.sh

# 4. æ‰§è¡Œå¯åŠ¨è„šæœ¬
/var/www/tongxun/server/start-server.sh
```

---

## ğŸ“ æ‰‹åŠ¨å¯åŠ¨æ­¥éª¤

### 1. è¿›å…¥é¡¹ç›®ç›®å½•

```bash
cd /var/www/tongxun/server
```

### 2. æ£€æŸ¥/åˆ›å»º .env æ–‡ä»¶

```bash
# å¦‚æœ.envæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
nano .env
```

**è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š**
```env
NODE_ENV=production
PORT=3000

DB_HOST=localhost
DB_PORT=3306
DB_USER=wangjia
DB_PASSWORD=qazQAZ123
DB_NAME=tongxun

REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

JWT_SECRET=your-very-secure-secret-key-change-this-in-production-min-32-chars
JWT_EXPIRES_IN=7d

WS_PATH=/ws
LOG_LEVEL=info
LOG_DIR=./logs
```

**ä¿å­˜æ–‡ä»¶ï¼š** `Ctrl+X` â†’ `Y` â†’ `Enter`

**è®¾ç½®æƒé™ï¼š**
```bash
chmod 600 .env
```

### 3. å®‰è£…ä¾èµ–

```bash
npm install --production
```

### 4. åˆ›å»ºæ—¥å¿—ç›®å½•

```bash
mkdir -p logs
```

### 5. å®‰è£…PM2ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰

```bash
npm install -g pm2
```

### 6. å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨PM2å¯åŠ¨
pm2 start ecosystem.config.js

# æˆ–è€…ç›´æ¥å¯åŠ¨ï¼ˆä¸æ¨èï¼Œç”¨äºæµ‹è¯•ï¼‰
# node src/index.js
```

### 7. ä¿å­˜PM2é…ç½®

```bash
pm2 save
```

### 8. è®¾ç½®å¼€æœºè‡ªå¯

```bash
pm2 startup
# ç„¶åæ‰§è¡Œè¾“å‡ºçš„å‘½ä»¤ï¼ˆé€šå¸¸æ˜¯ sudo env PATH=...ï¼‰
```

---

## ğŸ” å¸¸ç”¨ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
pm2 list
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æ—¥å¿—
pm2 logs tongxun-server

# æœ€è¿‘100è¡Œ
pm2 logs tongxun-server --lines 100

# åªæŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs tongxun-server --err

# åªæŸ¥çœ‹è¾“å‡ºæ—¥å¿—
pm2 logs tongxun-server --out
```

### é‡å¯æœåŠ¡

```bash
pm2 restart tongxun-server
```

### åœæ­¢æœåŠ¡

```bash
pm2 stop tongxun-server
```

### åˆ é™¤æœåŠ¡

```bash
pm2 delete tongxun-server
```

### æŸ¥çœ‹æœåŠ¡è¯¦æƒ…

```bash
pm2 show tongxun-server
```

### ç›‘æ§æœåŠ¡

```bash
pm2 monit
```

---

## âœ… éªŒè¯æœåŠ¡è¿è¡Œ

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
pm2 list
# åº”è¯¥çœ‹åˆ° tongxun-server çŠ¶æ€ä¸º online
```

### 2. æ£€æŸ¥ç«¯å£

```bash
netstat -tlnp | grep 3000
# æˆ–
ss -tlnp | grep 3000
```

### 3. æµ‹è¯•API

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæµ‹è¯•
curl http://localhost:3000/api/health

# åº”è¯¥è¿”å›ï¼š{"status":"ok","timestamp":"..."}
```

### 4. æ£€æŸ¥æ—¥å¿—

```bash
pm2 logs tongxun-server --lines 50
# åº”è¯¥çœ‹åˆ° "æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ 3000" å’Œ "æ•°æ®åº“è¿æ¥æˆåŠŸ"
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
pm2 logs tongxun-server --err

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
lsof -i :3000
# æˆ–
netstat -tlnp | grep 3000
```

### é—®é¢˜2ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u wangjia -p
# è¾“å…¥å¯†ç ï¼šqazQAZ123

# æ£€æŸ¥.envé…ç½®
cat .env | grep DB_
```

### é—®é¢˜3ï¼šRedisè¿æ¥å¤±è´¥

```bash
# æµ‹è¯•Redisè¿æ¥
redis-cli ping
# åº”è¯¥è¿”å›ï¼šPONG

# å¦‚æœRedisæœªå¯åŠ¨
systemctl start redis
systemctl enable redis
```

### é—®é¢˜4ï¼šç«¯å£è¢«å ç”¨

```bash
# æŸ¥æ‰¾å ç”¨3000ç«¯å£çš„è¿›ç¨‹
lsof -i :3000

# æ€æ­»è¿›ç¨‹ï¼ˆæ›¿æ¢PIDä¸ºå®é™…è¿›ç¨‹IDï¼‰
kill -9 PID

# æˆ–è€…ä¿®æ”¹.envä¸­çš„PORT
```

---

## ğŸ“Œ å®Œæ•´å¯åŠ¨å‘½ä»¤ï¼ˆä¸€è¡Œæ‰§è¡Œï¼‰

```bash
cd /var/www/tongxun/server && \
[ -f .env ] || cat > .env << 'EOF'
NODE_ENV=production
PORT=3000
DB_HOST=localhost
DB_PORT=3306
DB_USER=wangjia
DB_PASSWORD=qazQAZ123
DB_NAME=tongxun
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
JWT_SECRET=your-very-secure-secret-key-change-this-in-production-min-32-chars
JWT_EXPIRES_IN=7d
WS_PATH=/ws
LOG_LEVEL=info
LOG_DIR=./logs
EOF
chmod 600 .env && \
npm install --production && \
mkdir -p logs && \
pm2 stop tongxun-server 2>/dev/null; \
pm2 delete tongxun-server 2>/dev/null; \
pm2 start ecosystem.config.js && \
pm2 save && \
pm2 list
```

---

## ğŸ¯ å¿«é€Ÿæ£€æŸ¥æ¸…å•

å¯åŠ¨åæ£€æŸ¥ï¼š

- [ ] `pm2 list` æ˜¾ç¤ºæœåŠ¡çŠ¶æ€ä¸º `online`
- [ ] `curl http://localhost:3000/api/health` è¿”å›æ­£å¸¸
- [ ] `pm2 logs tongxun-server` æ˜¾ç¤º "æ•°æ®åº“è¿æ¥æˆåŠŸ"
- [ ] `pm2 logs tongxun-server` æ˜¾ç¤º "æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ 3000"
- [ ] é˜²ç«å¢™å·²å¼€æ”¾3000ç«¯å£
- [ ] é˜¿é‡Œäº‘å®‰å…¨ç»„å·²é…ç½®3000ç«¯å£

---

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ä¿®æ”¹JWT_SECRET**ï¼š
   ```bash
   # ç”Ÿæˆéšæœºå¯†é’¥
   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   # å°†ç”Ÿæˆçš„å¯†é’¥å¡«å…¥.envæ–‡ä»¶çš„JWT_SECRET
   ```

2. **é™åˆ¶.envæ–‡ä»¶æƒé™**ï¼š
   ```bash
   chmod 600 .env
   ```

3. **å®šæœŸæŸ¥çœ‹æ—¥å¿—**ï¼š
   ```bash
   pm2 logs tongxun-server --lines 100
   ```


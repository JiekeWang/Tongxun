# ä¸Šä¼ æœåŠ¡å™¨ä»£ç å‘½ä»¤

## éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶

åªä¿®æ”¹äº† `server/src/websocket/socketHandler.js`ï¼Œéœ€è¦ä¸Šä¼ è¿™ä¸ªæ–‡ä»¶ã€‚

## ä¸Šä¼ å‘½ä»¤

### æ–¹æ³•1ï¼šä½¿ç”¨ scpï¼ˆæ¨èï¼‰

```bash
# ä»æœ¬åœ° Windows ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp server/src/websocket/socketHandler.js root@47.116.197.230:/var/www/tongxun/server/src/websocket/socketHandler.js
```

### æ–¹æ³•2ï¼šä½¿ç”¨ PowerShellï¼ˆWindowsï¼‰

```powershell
# ä½¿ç”¨ scpï¼ˆéœ€è¦å®‰è£… OpenSSH å®¢æˆ·ç«¯ï¼‰
scp server/src/websocket/socketHandler.js root@47.116.197.230:/var/www/tongxun/server/src/websocket/socketHandler.js
```

### æ–¹æ³•3ï¼šä½¿ç”¨ WinSCP æˆ–å…¶ä»– FTP å·¥å…·

1. è¿æ¥åˆ°æœåŠ¡å™¨ï¼š`47.116.197.230`
2. ç”¨æˆ·åï¼š`root`
3. ä¸Šä¼ æ–‡ä»¶åˆ°ï¼š`/var/www/tongxun/server/src/websocket/socketHandler.js`

## å®Œæ•´æ“ä½œæ­¥éª¤

### 1. ä¸Šä¼ æ–‡ä»¶

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
scp server/src/websocket/socketHandler.js root@47.116.197.230:/var/www/tongxun/server/src/websocket/socketHandler.js
```

### 2. SSH è¿æ¥åˆ°æœåŠ¡å™¨

```bash
ssh root@47.116.197.230
```

### 3. è¿›å…¥æœåŠ¡å™¨ç›®å½•

```bash
cd /var/www/tongxun/server
```

### 4. éªŒè¯æ–‡ä»¶å·²ä¸Šä¼ 

```bash
# æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼Œç¡®è®¤å·²æ›´æ–°
head -20 src/websocket/socketHandler.js
# æˆ–è€…æŸ¥çœ‹æ–‡ä»¶ä¿®æ”¹æ—¶é—´
ls -lh src/websocket/socketHandler.js
```

### 5. é‡å¯æœåŠ¡å™¨

```bash
# å¦‚æœä½¿ç”¨ PM2
pm2 restart tongxun

# æˆ–è€…å¦‚æœä½¿ç”¨ systemd
systemctl restart tongxun

# æˆ–è€…å¦‚æœç›´æ¥è¿è¡Œ node
# å…ˆåœæ­¢å½“å‰è¿›ç¨‹ï¼Œç„¶åé‡æ–°å¯åŠ¨
cd /var/www/tongxun/server
npm start
```

### 6. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤

```bash
# å¦‚æœä½¿ç”¨ PM2
pm2 logs tongxun

# æˆ–è€…æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f /var/www/tongxun/server/logs/app.log
```

## ä¸€é”®ä¸Šä¼ è„šæœ¬ï¼ˆå¯é€‰ï¼‰

åˆ›å»º `upload-socket-handler.ps1`ï¼š

```powershell
# ä¸Šä¼  socketHandler.js åˆ°æœåŠ¡å™¨
$server = "root@47.116.197.230"
$localFile = "server/src/websocket/socketHandler.js"
$remotePath = "/var/www/tongxun/server/src/websocket/socketHandler.js"

Write-Host "æ­£åœ¨ä¸Šä¼ æ–‡ä»¶..." -ForegroundColor Yellow
scp $localFile "${server}:${remotePath}"

if ($LASTEXITCODE -eq 0) {
    Write-Host "âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼" -ForegroundColor Green
    Write-Host "è¯· SSH è¿æ¥åˆ°æœåŠ¡å™¨å¹¶é‡å¯æœåŠ¡" -ForegroundColor Yellow
    Write-Host "ssh $server" -ForegroundColor Cyan
    Write-Host "cd /var/www/tongxun/server && pm2 restart tongxun" -ForegroundColor Cyan
} else {
    Write-Host "âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼" -ForegroundColor Red
}
```

## æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½åŸæ–‡ä»¶**ï¼ˆå¯é€‰ï¼‰ï¼š
   ```bash
   ssh root@47.116.197.230
   cd /var/www/tongxun/server
   cp src/websocket/socketHandler.js src/websocket/socketHandler.js.backup
   ```

2. **ç¡®è®¤æ–‡ä»¶è·¯å¾„**ï¼š
   - æœ¬åœ°è·¯å¾„ï¼š`server/src/websocket/socketHandler.js`
   - æœåŠ¡å™¨è·¯å¾„ï¼š`/var/www/tongxun/server/src/websocket/socketHandler.js`

3. **æƒé™é—®é¢˜**ï¼š
   å¦‚æœä¸Šä¼ åæ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œå¯èƒ½éœ€è¦ï¼š
   ```bash
   chmod 644 /var/www/tongxun/server/src/websocket/socketHandler.js
   ```

4. **é‡å¯æœåŠ¡**ï¼š
   ä¸Šä¼ åå¿…é¡»é‡å¯æœåŠ¡å™¨æ‰èƒ½ç”Ÿæ•ˆã€‚

## éªŒè¯æ›´æ–°æ˜¯å¦æˆåŠŸ

ä¸Šä¼ å¹¶é‡å¯åï¼Œå‘é€ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ï¼ŒæŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—åº”è¯¥çœ‹åˆ°ï¼š

```
ğŸ”¥ æ”¶åˆ°messageäº‹ä»¶ - socketId: xxx, userId: xxx, data: {...}
æ”¶åˆ°æ¶ˆæ¯ - senderId: xxx, receiverId: xxx, messageId: xxx, ...
å‡†å¤‡ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“ - messageId: xxx
âœ… æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“ - messageId: xxx, insertId: xxx
```


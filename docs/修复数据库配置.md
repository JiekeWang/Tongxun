# 修复数据库配置

## 问题
`.env` 文件中数据库用户名和密码不匹配，导致服务无法启动。

## 解决步骤

### 1. 在服务器上编辑 `.env` 文件

```bash
cd /var/www/tongxun/server
vim .env
# 或者使用 nano
nano .env
```

### 2. 修改以下配置项

将：
```env
DB_USER=root
DB_PASSWORD=qazQAZ123
DB_NAME=Tongxun
```

改为：
```env
DB_USER=wangjia
DB_PASSWORD=qazQAZ123
DB_NAME=tongxun
```

**注意**：
- 数据库名改为小写 `tongxun`（MySQL在Linux上默认大小写敏感）
- 用户名改为 `wangjia`（之前创建的数据库用户）

### 3. 保存并退出

- vim: 按 `Esc`，输入 `:wq`，回车
- nano: 按 `Ctrl+X`，输入 `Y` 确认，回车

### 4. 验证数据库用户是否存在

```bash
mysql -u root -p
# 输入 root 密码
```

在 MySQL 中执行：
```sql
-- 检查用户是否存在
SELECT User, Host FROM mysql.user WHERE User = 'wangjia';

-- 如果不存在，创建用户
CREATE USER IF NOT EXISTS 'wangjia'@'localhost' IDENTIFIED BY 'qazQAZ123';
GRANT ALL PRIVILEGES ON tongxun.* TO 'wangjia'@'localhost';
FLUSH PRIVILEGES;

-- 检查数据库是否存在
SHOW DATABASES LIKE 'tongxun';

-- 如果不存在，创建数据库
CREATE DATABASE IF NOT EXISTS tongxun DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

EXIT;
```

### 5. 测试数据库连接

```bash
mysql -u wangjia -p tongxun
# 输入密码：qazQAZ123
# 如果成功连接，说明配置正确
EXIT;
```

### 6. 重启服务

```bash
cd /var/www/tongxun/server
pm2 restart tongxun-server --update-env
```

### 7. 查看日志确认

```bash
pm2 logs tongxun-server --lines 20
```

应该看到：
```
数据库连接成功
数据库表创建/检查完成
服务器运行在端口 3000
```

### 8. 验证服务

```bash
curl http://localhost:3000/api/health
```

应该返回：
```json
{"status":"ok","timestamp":"2025-12-04T..."}
```

## 如果还是连接失败

### 方案A：使用 root 用户（如果 root 密码确实是 qazQAZ123）

修改 `.env`：
```env
DB_USER=root
DB_PASSWORD=qazQAZ123
DB_NAME=tongxun
```

然后重置 root 密码：
```bash
mysql -u root -p
# 输入当前 root 密码
ALTER USER 'root'@'localhost' IDENTIFIED BY 'qazQAZ123';
FLUSH PRIVILEGES;
EXIT;
```

### 方案B：确认 wangjia 用户密码

```bash
mysql -u root -p
ALTER USER 'wangjia'@'localhost' IDENTIFIED BY 'qazQAZ123';
FLUSH PRIVILEGES;
EXIT;
```


# ç”Ÿäº§ç¯å¢ƒé…ç½®æ¸…å•

## ğŸ“‹ é…ç½®ä¿¡æ¯

- **å…¬ç½‘åŸŸå**: zhihome.com.cn
- **å…¬ç½‘IP**: 47.116.197.230
- **æ•°æ®åº“ç”¨æˆ·å**: wangjia
- **æ•°æ®åº“å¯†ç **: qazQAZ123

---

## âœ… éœ€è¦ä¿®æ”¹çš„é…ç½®

### 1. Androidå®¢æˆ·ç«¯ - BASE_URL

**æ–‡ä»¶**: `app/src/main/java/com/tongxun/data/remote/NetworkModule.kt`

**å·²ä¿®æ”¹ä¸º**:
```kotlin
const val BASE_URL = "http://zhihome.com.cn:3000/api/"
```

**é€‰é¡¹è¯´æ˜**:
- ä½¿ç”¨åŸŸåï¼ˆå½“å‰ï¼‰ï¼š`http://zhihome.com.cn:3000/api/`
- ä½¿ç”¨IPï¼š`http://47.116.197.230:3000/api/`
- å¦‚æœé…ç½®äº†Nginxå’ŒHTTPSï¼š`https://zhihome.com.cn/api/`

### 2. æœåŠ¡å™¨ç«¯ - .envæ–‡ä»¶

**æ–‡ä»¶ä½ç½®**: `/var/www/tongxun/server/.env`

**éœ€è¦é…ç½®**:
```env
NODE_ENV=production
PORT=3000

DB_HOST=localhost
DB_PORT=3306
DB_USER=wangjia
DB_PASSWORD=qazQAZ123
DB_NAME=tongxun

REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

JWT_SECRET=your-very-secure-secret-key-change-this-in-production-min-32-chars
JWT_EXPIRES_IN=7d

WS_PATH=/ws
LOG_LEVEL=info
LOG_DIR=./logs
```

### 3. æœåŠ¡å™¨ç«¯ - Socket.IO CORSé…ç½®ï¼ˆå¯é€‰ï¼‰

**æ–‡ä»¶**: `server/src/index.js`

å¦‚æœéœ€è¦é™åˆ¶CORSï¼Œå¯ä»¥ä¿®æ”¹ï¼š
```javascript
const io = new Server(server, {
  cors: {
    origin: ["https://zhihome.com.cn", "http://zhihome.com.cn"], // é™åˆ¶ä¸ºä½ çš„åŸŸå
    methods: ["GET", "POST"]
  },
  // ...
});
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/tongxun/server

# 2. åˆ›å»º.envæ–‡ä»¶
nano .env

# 3. è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼ˆä½¿ç”¨æä¾›çš„æ•°æ®åº“ä¿¡æ¯ï¼‰
NODE_ENV=production
PORT=3000
DB_HOST=localhost
DB_PORT=3306
DB_USER=wangjia
DB_PASSWORD=qazQAZ123
DB_NAME=tongxun
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
JWT_SECRET=your-very-secure-secret-key-change-this-in-production-min-32-chars
JWT_EXPIRES_IN=7d
WS_PATH=/ws
LOG_LEVEL=info
LOG_DIR=./logs

# 4. ä¿å­˜æ–‡ä»¶ï¼ˆCtrl+X, Y, Enterï¼‰

# 5. è®¾ç½®æ–‡ä»¶æƒé™
chmod 600 .env

# 6. æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u wangjia -p
# è¾“å…¥å¯†ç ï¼šqazQAZ123
# åœ¨MySQLä¸­ï¼š
USE tongxun;
SHOW TABLES;
EXIT;

# 7. é‡å¯æœåŠ¡
pm2 restart tongxun-server

# 8. æŸ¥çœ‹æ—¥å¿—
pm2 logs tongxun-server
```

---

## ğŸ”§ å®¢æˆ·ç«¯ä¿®æ”¹

### é‡æ–°ç¼–è¯‘APK

```bash
# åœ¨Android Studioä¸­
# Build â†’ Generate Signed Bundle / APK
# æˆ–
./gradlew assembleRelease
```

**APKä½ç½®**: `app/build/outputs/apk/release/app-release.apk`

---

## ğŸŒ åŸŸåè§£æé…ç½®

### ç¡®ä¿åŸŸåå·²è§£æåˆ°æœåŠ¡å™¨IP

```bash
# åœ¨æœ¬åœ°æµ‹è¯•åŸŸåè§£æ
ping zhihome.com.cn
# åº”è¯¥è¿”å›ï¼š47.116.197.230

# æˆ–ä½¿ç”¨nslookup
nslookup zhihome.com.cn
```

### å¦‚æœåŸŸåæœªè§£æ

1. ç™»å½•åŸŸåç®¡ç†åå°
2. æ·»åŠ Aè®°å½•ï¼š
   - ä¸»æœºè®°å½•ï¼š`@` æˆ– `www`
   - è®°å½•ç±»å‹ï¼š`A`
   - è®°å½•å€¼ï¼š`47.116.197.230`
   - TTLï¼š600

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. ä¿®æ”¹JWT_SECRET

```bash
# ç”Ÿæˆéšæœºå¯†é’¥ï¼ˆåœ¨æœåŠ¡å™¨ä¸Šï¼‰
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# å°†ç”Ÿæˆçš„å¯†é’¥å¡«å…¥.envæ–‡ä»¶çš„JWT_SECRET
```

### 2. é…ç½®HTTPSï¼ˆæ¨èï¼‰

```bash
# å®‰è£…Certbot
yum install certbot python3-certbot-nginx -y

# è·å–SSLè¯ä¹¦
certbot --nginx -d zhihome.com.cn

# ç„¶åä¿®æ”¹å®¢æˆ·ç«¯BASE_URLä¸ºï¼š
# const val BASE_URL = "https://zhihome.com.cn/api/"
```

### 3. é…ç½®Nginxåå‘ä»£ç†ï¼ˆæ¨èï¼‰

```nginx
server {
    listen 80;
    server_name zhihome.com.cn;

    # é‡å®šå‘åˆ°HTTPSï¼ˆå¦‚æœé…ç½®äº†SSLï¼‰
    # return 301 https://$server_name$request_uri;

    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }
}
```

---

## âœ… éªŒè¯é…ç½®

### 1. æµ‹è¯•APIè®¿é—®

```bash
# åœ¨æœ¬åœ°æµ‹è¯•
curl http://zhihome.com.cn:3000/api/health
# æˆ–
curl http://47.116.197.230:3000/api/health
```

### 2. æµ‹è¯•æ•°æ®åº“è¿æ¥

```bash
# åœ¨æœåŠ¡å™¨ä¸Š
mysql -u wangjia -p
# è¾“å…¥å¯†ç ï¼šqazQAZ123
USE tongxun;
SHOW TABLES;
EXIT;
```

### 3. æµ‹è¯•Redisè¿æ¥

```bash
redis-cli ping
# åº”è¯¥è¿”å›ï¼šPONG
```

---

## ğŸ“ é…ç½®æ£€æŸ¥æ¸…å•

- [ ] Androidå®¢æˆ·ç«¯BASE_URLå·²ä¿®æ”¹ä¸ºåŸŸåæˆ–IP
- [ ] æœåŠ¡å™¨.envæ–‡ä»¶å·²é…ç½®æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç 
- [ ] æ•°æ®åº“ç”¨æˆ·wangjiaå·²åˆ›å»ºå¹¶æˆæƒ
- [ ] åŸŸåå·²è§£æåˆ°æœåŠ¡å™¨IP
- [ ] é˜²ç«å¢™å·²å¼€æ”¾3000ç«¯å£
- [ ] é˜¿é‡Œäº‘å®‰å…¨ç»„å·²é…ç½®3000ç«¯å£
- [ ] æœåŠ¡å·²é‡å¯ï¼ˆpm2 restartï¼‰
- [ ] APIå¯ä»¥è®¿é—®ï¼ˆcurlæµ‹è¯•ï¼‰
- [ ] å®¢æˆ·ç«¯å¯ä»¥è¿æ¥æœåŠ¡å™¨

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### åŸŸåæ— æ³•è®¿é—®

1. æ£€æŸ¥åŸŸåè§£æï¼š`ping zhihome.com.cn`
2. æ£€æŸ¥é˜²ç«å¢™ï¼š`firewall-cmd --list-ports`
3. æ£€æŸ¥å®‰å…¨ç»„ï¼šé˜¿é‡Œäº‘æ§åˆ¶å° â†’ å®‰å…¨ç»„
4. æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š`pm2 list`

### æ•°æ®åº“è¿æ¥å¤±è´¥

1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼š`mysql -u wangjia -p`
2. æ£€æŸ¥ç”¨æˆ·æƒé™ï¼š`SHOW GRANTS FOR 'wangjia'@'localhost';`
3. æ£€æŸ¥.envé…ç½®ï¼š`cat /var/www/tongxun/server/.env | grep DB_`

### WebSocketè¿æ¥å¤±è´¥

1. æ£€æŸ¥WebSocket URLæ ¼å¼
2. æ£€æŸ¥é˜²ç«å¢™å’Œå®‰å…¨ç»„
3. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ï¼š`pm2 logs tongxun-server`


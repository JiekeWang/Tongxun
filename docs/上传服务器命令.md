# 服务器上传命令

## 当前状态

✅ **客户端代码已优化完成**（无需上传）
- 会话去重逻辑
- 头像上传与展示
- 消息页面UI优化

⚠️ **服务器端代码已优化**（建议上传）
- 修复了重复调用 `updateConversation` 的问题
- 优化了会话更新逻辑

---

## ⚠️ 重要提示

**不要直接使用 `scp -r server` 上传！这会覆盖服务器上的 `.env` 文件！**

请使用**安全上传脚本**或参考 `上传服务器安全指南.md`。

---

## 上传命令

### 方法1：使用安全上传脚本（⭐ 强烈推荐）

```powershell
# 在 Windows PowerShell 中执行
.\upload-server-safe.ps1 -ServerIP "your-server-ip"

# 示例
.\upload-server-safe.ps1 -ServerIP "47.116.197.230"
```

**脚本会自动：**
- ✅ 排除 `.env` 文件（不会覆盖）
- ✅ 排除 `node_modules`、`logs` 等
- ✅ 压缩上传，提高效率

---

### 方法2：使用 SCP 上传（⚠️ 需手动保护 .env）

**注意：此方法会覆盖 `.env` 文件，上传后需要恢复配置！**

---

### 方法2：使用 tar 压缩上传（适合大文件或网络不稳定）

```powershell
# 1. 在本地压缩 server 目录
cd E:\Tongxun
tar -czf server.tar.gz server

# 2. 上传压缩包
scp server.tar.gz root@your-server-ip:/tmp/

# 3. SSH 连接到服务器并解压
ssh root@your-server-ip

# 在服务器上执行：
cd /var/www/tongxun
tar -xzf /tmp/server.tar.gz
rm -rf /tmp/server.tar.gz

# 如果解压后的目录结构是 server/，则移动文件
mv server/* .
rm -rf server
```

---

### 方法3：使用 Git（如果代码在 Git 仓库）

```bash
# 在服务器上执行
ssh root@your-server-ip
cd /var/www/tongxun
git pull origin main  # 或你的分支名
```

---

## 上传后操作

### 1. 进入服务器目录

```bash
ssh root@your-server-ip
cd /var/www/tongxun/server
```

### 2. 安装/更新依赖（如果需要）

```bash
npm install
```

### 3. 重启服务

```bash
# 如果使用 PM2 管理
pm2 restart tongxun-server

# 或者
pm2 reload tongxun-server

# 查看服务状态
pm2 status
pm2 logs tongxun-server --lines 50
```

---

## 验证部署

```bash
# 检查服务是否运行
pm2 status

# 查看日志
pm2 logs tongxun-server --lines 100

# 检查端口
netstat -tlnp | grep 3000
```

---

## 注意事项

1. **备份现有代码**（如果服务器上已有代码）：
   ```bash
   ssh root@your-server-ip
   cd /var/www/tongxun/server
   cp -r src src.backup.$(date +%Y%m%d_%H%M%S)
   ```

2. **检查环境变量**：确保 `.env` 文件配置正确
   ```bash
   cat /var/www/tongxun/server/.env
   ```

3. **数据库无需迁移**：本次更新不涉及数据库结构变化

---

## 快速上传脚本（Windows PowerShell）

保存为 `upload-server.ps1`：

```powershell
$SERVER_IP = "your-server-ip"  # 替换为你的服务器IP
$SERVER_PATH = "/var/www/tongxun"

Write-Host "开始上传 server 目录到服务器..." -ForegroundColor Green

# 上传
scp -r server root@${SERVER_IP}:${SERVER_PATH}/

Write-Host "上传完成！" -ForegroundColor Green
Write-Host "请SSH连接到服务器并执行以下命令：" -ForegroundColor Yellow
Write-Host "  cd ${SERVER_PATH}/server" -ForegroundColor Cyan
Write-Host "  pm2 restart tongxun-server" -ForegroundColor Cyan
```

**使用方法：**
```powershell
.\upload-server.ps1
```


# æ¶ˆæ¯æ¥æ”¶æ¨¡å—ç¡®è®¤

## âœ… æ¥æ”¶æ¶ˆæ¯æ¨¡å—å·²å®Œæ•´å®ç°

### 1. WebSocketManager - æ ¸å¿ƒæ¶ˆæ¯æ¥æ”¶å±‚
**æ–‡ä»¶**: `app/src/main/java/com/tongxun/data/remote/WebSocketManager.kt`

**åŠŸèƒ½**:
- âœ… `onMessage()` - æ¥æ”¶åŸå§‹WebSocketæ¶ˆæ¯
- âœ… è§£æSocket.IOåè®®æ ¼å¼: `42["event_name", {...}]`
- âœ… è§£ææ ‡å‡†JSONæ ¼å¼
- âœ… å‘é€ `FriendRequestReceived` çŠ¶æ€åˆ°Flow

**å…³é”®ä»£ç ä½ç½®**:
- ç¬¬76-197è¡Œ: `onMessage()` æ–¹æ³•
- ç¬¬102-118è¡Œ: å¤„ç† `friend_request` äº‹ä»¶
- ç¬¬310-318è¡Œ: `FriendRequestReceived` çŠ¶æ€å®šä¹‰

### 2. MainViewModel - å…¨å±€æ¶ˆæ¯ç›‘å¬
**æ–‡ä»¶**: `app/src/main/java/com/tongxun/ui/main/MainViewModel.kt`

**åŠŸèƒ½**:
- âœ… `setupWebSocketListener()` - ç›‘å¬WebSocketçŠ¶æ€
- âœ… å¤„ç† `FriendRequestReceived` å¹¶åˆ·æ–°å¥½å‹è¯·æ±‚åˆ—è¡¨

**å…³é”®ä»£ç ä½ç½®**:
- ç¬¬44-74è¡Œ: `setupWebSocketListener()` æ–¹æ³•
- ç¬¬56-67è¡Œ: å¤„ç†å¥½å‹è¯·æ±‚é€šçŸ¥

### 3. FriendRequestViewModel - å¥½å‹è¯·æ±‚é¡µé¢ç›‘å¬
**æ–‡ä»¶**: `app/src/main/java/com/tongxun/ui/contact/FriendRequestViewModel.kt`

**åŠŸèƒ½**:
- âœ… `setupWebSocketListener()` - ç›‘å¬å¥½å‹è¯·æ±‚é€šçŸ¥
- âœ… æ”¶åˆ°é€šçŸ¥åè‡ªåŠ¨è°ƒç”¨ `loadFriendRequests()` åˆ·æ–°åˆ—è¡¨

**å…³é”®ä»£ç ä½ç½®**:
- ç¬¬32-47è¡Œ: `setupWebSocketListener()` æ–¹æ³•
- ç¬¬37-40è¡Œ: å¤„ç† `FriendRequestReceived` çŠ¶æ€

### 4. ContactViewModel - è”ç³»äººé¡µé¢ç›‘å¬
**æ–‡ä»¶**: `app/src/main/java/com/tongxun/ui/contact/ContactViewModel.kt`

**åŠŸèƒ½**:
- âœ… `setupWebSocketListener()` - ç›‘å¬å¥½å‹è¯·æ±‚é€šçŸ¥
- âœ… æ”¶åˆ°é€šçŸ¥åè‡ªåŠ¨åˆ·æ–°å¥½å‹è¯·æ±‚æ•°é‡

### 5. MainActivity - WebSocketåˆå§‹åŒ–
**æ–‡ä»¶**: `app/src/main/java/com/tongxun/ui/main/MainActivity.kt`

**åŠŸèƒ½**:
- âœ… `initWebSocket()` - åˆå§‹åŒ–WebSocketè¿æ¥
- âœ… ç›‘å¬è¿æ¥çŠ¶æ€å¹¶è®°å½•æ—¥å¿—

**å…³é”®ä»£ç ä½ç½®**:
- ç¬¬38-73è¡Œ: `initWebSocket()` æ–¹æ³•

## ğŸ“Š æ¶ˆæ¯æ¥æ”¶æµç¨‹

```
æœåŠ¡å™¨å‘é€æ¶ˆæ¯
    â†“
Socket.IO emit('friend_request', data)
    â†“
WebSocketManager.onMessage() æ¥æ”¶åŸå§‹æ¶ˆæ¯
    â†“
è§£ææ¶ˆæ¯æ ¼å¼ (Socket.IO: 42["friend_request", {...}])
    â†“
å‘é€ ConnectionState.FriendRequestReceived åˆ°Flow
    â†“
MainViewModel.setupWebSocketListener() ç›‘å¬
    â†“
è°ƒç”¨ friendRepository.getFriendRequests() åˆ·æ–°åˆ—è¡¨
    â†“
FriendRequestViewModel.setupWebSocketListener() ç›‘å¬
    â†“
è°ƒç”¨ loadFriendRequests() åˆ·æ–°UI
    â†“
ContactViewModel.setupWebSocketListener() ç›‘å¬
    â†“
è°ƒç”¨ loadFriendRequestCount() åˆ·æ–°æ•°é‡
```

## âš ï¸ å½“å‰é—®é¢˜

**é—®é¢˜**: æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯

**å¯èƒ½åŸå› **:
1. âŒ WebSocketè¿æ¥æœªæˆåŠŸå»ºç«‹
   - æ£€æŸ¥å®¢æˆ·ç«¯Logcatæ˜¯å¦æœ‰ "WebSocket connected" æ—¥å¿—
   - æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—æ˜¯å¦æœ‰ "ç”¨æˆ· XXX è¿æ¥WebSocket" æ—¥å¿—

2. âŒ Socket.IOåè®®ä¸å…¼å®¹
   - OkHttp WebSocketæ˜¯æ ‡å‡†WebSocket
   - Socket.IOä½¿ç”¨Engine.IOåè®®
   - éœ€è¦ç‰¹å®šçš„æ¡æ‰‹å’Œåè®®æ ¼å¼

3. âŒ æœåŠ¡å™¨ç«¯æœªå‘é€æ¶ˆæ¯
   - æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—æ˜¯å¦æœ‰ "å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·" æ—¥å¿—
   - æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—æ˜¯å¦æœ‰ "æ¶ˆæ¯å·²å‘é€" æ—¥å¿—

## ğŸ” æ’æŸ¥æ­¥éª¤

1. **æ£€æŸ¥å®¢æˆ·ç«¯è¿æ¥**:
   - æŸ¥çœ‹Logcat: `WebSocketManager`, `MainActivity`
   - åº”è¯¥çœ‹åˆ°: "WebSocketåˆå§‹åŒ–", "WebSocket connected"

2. **æ£€æŸ¥æœåŠ¡å™¨è¿æ¥**:
   - æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—: `logs/combined.log`
   - åº”è¯¥çœ‹åˆ°: "ç”¨æˆ· XXX è¿æ¥WebSocket"

3. **æ£€æŸ¥æ¶ˆæ¯å‘é€**:
   - å‘é€å¥½å‹è¯·æ±‚æ—¶ï¼ŒæŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
   - åº”è¯¥çœ‹åˆ°: "å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·", "æ¶ˆæ¯å·²å‘é€"

4. **æ£€æŸ¥æ¶ˆæ¯æ¥æ”¶**:
   - æŸ¥çœ‹å®¢æˆ·ç«¯Logcat
   - åº”è¯¥çœ‹åˆ°: "Received raw message", "æ”¶åˆ°å¥½å‹è¯·æ±‚é€šçŸ¥"

## ğŸ“ ç»“è®º

âœ… **æ¥æ”¶æ¶ˆæ¯æ¨¡å—å·²å®Œæ•´å®ç°**
âŒ **ä½†WebSocketè¿æ¥å¯èƒ½æœªæˆåŠŸå»ºç«‹**

éœ€è¦æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€å’Œåè®®å…¼å®¹æ€§é—®é¢˜ã€‚


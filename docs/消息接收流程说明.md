# 消息接收流程说明

## 📋 消息接收的两种方式

### 1. 实时接收（WebSocket）
- **触发时机**：`MainViewModel` 初始化时（应用启动或登录后进入 MainActivity）
- **位置**：`MainViewModel.setupWebSocketListener()`
- **流程**：
  1. 建立 WebSocket 连接
  2. 监听 `message` 事件
  3. 收到消息后调用 `MessageRepositoryImpl.handleReceivedMessage()`
  4. 保存到本地数据库
  5. UI 自动更新（通过 Flow）

### 2. 离线消息拉取（HTTP）
- **触发时机**：`MainViewModel` 初始化时
- **位置**：`MainViewModel.fetchOfflineMessages()`
- **流程**：
  1. 获取最后一条消息的时间戳
  2. 发送 HTTP 请求：`GET /api/messages/offline?lastMessageTime=xxx`
  3. 收到响应后保存到本地数据库
  4. 更新会话未读数
  5. UI 自动更新（通过 Flow）

## 🔍 关键日志点

### 1. MainViewModel 初始化
```
🔥🔥🔥 MainViewModel.init() 被调用 - 代码已更新 🔥🔥🔥
开始拉取离线消息 - lastMessageTime=xxx
```

### 2. 离线消息拉取
```
🔥🔥🔥 fetchOfflineMessages() 被调用 - lastMessageTime: xxx
准备发送HTTP请求拉取离线消息 - lastMessageTime: xxx
✅✅✅ 收到离线消息响应 - 消息数量: X
✅✅✅ 离线消息已保存到本地数据库 - 消息数量: X
```

### 3. WebSocket 连接
```
🚀 开始连接WebSocket - URL: xxx
WebSocket连接成功
```

### 4. 实时消息接收
```
🔥 收到message事件 - args数量: X, data: {...}
✅ 解析消息成功 - messageId=xxx
🔥🔥🔥 收到消息通知 - messageId=xxx, senderId=xxx, receiverId=xxx
✅✅✅ 消息已保存到本地数据库 - messageId=xxx
```

### 5. 消息页显示
```
🔥🔥🔥 HomeFragment.onResume() 被调用 - 消息页已显示
```

## ⚠️ 重要说明

1. **消息页（HomeFragment）不主动拉取消息**
   - 它只显示本地数据库的会话列表
   - 消息通过 WebSocket 实时接收或离线消息拉取后自动显示

2. **登录后会自动拉取**
   - 登录成功后跳转到 MainActivity
   - MainActivity 初始化时会创建 MainViewModel
   - MainViewModel 初始化时会：
     - 建立 WebSocket 连接（实时接收）
     - 拉取离线消息（HTTP 请求）

3. **切换到消息页不会拉取**
   - 消息页只显示本地数据库的内容
   - 如果需要刷新，需要：
     - 重新启动应用（会触发 MainViewModel 初始化）
     - 或者等待 WebSocket 接收新消息

## 🔧 如何验证消息接收

### 1. 检查离线消息拉取
在 Logcat 中搜索：
```
fetchOfflineMessages
```

应该看到：
- `🔥🔥🔥 fetchOfflineMessages() 被调用`
- `准备发送HTTP请求拉取离线消息`
- `✅✅✅ 收到离线消息响应`

### 2. 检查 WebSocket 连接
在 Logcat 中搜索：
```
WebSocketManager
```

应该看到：
- `🚀 开始连接WebSocket`
- `WebSocket连接成功`

### 3. 检查实时消息接收
在 Logcat 中搜索：
```
收到message事件
```

应该看到：
- `🔥 收到message事件`
- `✅ 解析消息成功`
- `🔥🔥🔥 收到消息通知`
- `✅✅✅ 消息已保存到本地数据库`

## 📱 测试步骤

1. **清空应用数据**（确保从干净状态开始）
2. **启动应用并登录**
3. **查看 Logcat**，应该看到：
   - MainViewModel 初始化日志
   - 离线消息拉取日志（如果有离线消息）
   - WebSocket 连接日志
4. **发送测试消息**（从另一个设备或账号）
5. **查看 Logcat**，应该看到：
   - WebSocket 收到消息的日志
   - 消息保存到数据库的日志
6. **检查消息页**，应该能看到新消息

## 🐛 常见问题

### Q: 为什么看不到拉取离线消息的 HTTP 请求？
A: 检查以下几点：
1. MainViewModel 是否被初始化（查看 `🔥🔥🔥 MainViewModel.init() 被调用` 日志）
2. 是否有网络请求日志（查看 OkHttp 日志）
3. 服务器是否返回了消息（查看 `✅✅✅ 收到离线消息响应` 日志）

### Q: 为什么切换到消息页看不到新消息？
A: 可能原因：
1. 消息没有通过 WebSocket 接收（检查 WebSocket 连接日志）
2. 消息没有保存到数据库（检查 `✅✅✅ 消息已保存到本地数据库` 日志）
3. 消息页的 Flow 没有更新（检查 HomeFragment 的日志）

### Q: 登录时会拉取消息吗？
A: 会的。登录成功后跳转到 MainActivity，MainActivity 会创建 MainViewModel，MainViewModel 初始化时会拉取离线消息。


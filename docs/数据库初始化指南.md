# 数据库初始化指南

## 📋 数据库信息

- **数据库名称**: `tongxun`
- **数据库用户名**: `wangjia`
- **数据库密码**: `qazQAZ123`

---

## 🚀 快速初始化（推荐）

### 方法1：使用SQL脚本（最简单）

```bash
# 1. 登录MySQL（使用root用户）
mysql -u root -p
# 输入root密码

# 2. 执行SQL脚本
source /var/www/tongxun/server/init-database.sql

# 或者直接执行：
mysql -u root -p < /var/www/tongxun/server/init-database.sql

# 3. 验证
mysql -u wangjia -p
# 输入密码：qazQAZ123
USE tongxun;
SHOW TABLES;
EXIT;
```

---

## 📝 手动创建步骤

### 1. 登录MySQL

```bash
mysql -u root -p
# 输入root密码
```

### 2. 创建数据库

```sql
CREATE DATABASE IF NOT EXISTS tongxun CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 3. 创建用户

```sql
CREATE USER IF NOT EXISTS 'wangjia'@'localhost' IDENTIFIED BY 'qazQAZ123';
```

### 4. 授予权限

```sql
GRANT ALL PRIVILEGES ON tongxun.* TO 'wangjia'@'localhost';
FLUSH PRIVILEGES;
```

### 5. 验证

```sql
-- 查看数据库
SHOW DATABASES LIKE 'tongxun';

-- 查看用户权限
SHOW GRANTS FOR 'wangjia'@'localhost';

-- 退出
EXIT;
```

### 6. 测试连接

```bash
# 使用新用户登录
mysql -u wangjia -p
# 输入密码：qazQAZ123

# 切换到数据库
USE tongxun;

# 查看表（此时应该为空，表会在服务启动时自动创建）
SHOW TABLES;

# 退出
EXIT;
```

---

## ✅ 验证清单

- [ ] 数据库 `tongxun` 已创建
- [ ] 用户 `wangjia` 已创建
- [ ] 用户权限已授予
- [ ] 可以使用 `wangjia` 用户登录
- [ ] 可以访问 `tongxun` 数据库

---

## 🔧 如果遇到问题

### 问题1：无法使用root登录

```bash
# 尝试使用sudo
sudo mysql -u root

# 或者重置root密码
sudo systemctl stop mysql
sudo mysqld_safe --skip-grant-tables &
mysql -u root
# 然后执行：
ALTER USER 'root'@'localhost' IDENTIFIED BY '新密码';
FLUSH PRIVILEGES;
EXIT;
sudo systemctl restart mysql
```

### 问题2：用户已存在

```sql
-- 删除旧用户
DROP USER IF EXISTS 'wangjia'@'localhost';

-- 重新创建
CREATE USER 'wangjia'@'localhost' IDENTIFIED BY 'qazQAZ123';
GRANT ALL PRIVILEGES ON tongxun.* TO 'wangjia'@'localhost';
FLUSH PRIVILEGES;
```

### 问题3：权限不足

```sql
-- 检查当前用户权限
SHOW GRANTS FOR CURRENT_USER();

-- 如果需要，使用root重新授权
GRANT ALL PRIVILEGES ON tongxun.* TO 'wangjia'@'localhost' WITH GRANT OPTION;
FLUSH PRIVILEGES;
```

---

## 📌 注意事项

1. **字符集**: 数据库使用 `utf8mb4` 以支持emoji和特殊字符
2. **用户权限**: `wangjia` 用户只能访问 `tongxun` 数据库，不能访问其他数据库
3. **表结构**: 数据库表会在Node.js服务启动时自动创建（通过 `database.js` 中的 `createTables()` 函数）
4. **安全性**: 生产环境建议：
   - 使用强密码
   - 限制用户只能从localhost连接
   - 定期备份数据库

---

## 🔄 后续步骤

数据库初始化完成后：

1. **配置.env文件**（如果还没有）:
   ```bash
   cd /var/www/tongxun/server
   nano .env
   ```

2. **启动服务**:
   ```bash
   pm2 start ecosystem.config.js
   # 或
   pm2 restart tongxun-server
   ```

3. **查看日志**:
   ```bash
   pm2 logs tongxun-server
   ```

4. **验证表已创建**:
   ```bash
   mysql -u wangjia -p
   USE tongxun;
   SHOW TABLES;
   # 应该看到：users, friends, friend_requests, messages, conversations 等表
   ```


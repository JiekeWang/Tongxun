# æŸ¥è¯¢æ¶ˆæ¯è¡¨å’Œæ¨é€é—®é¢˜æ’æŸ¥

## ğŸ“Š ä¸»è¦æ•°æ®è¡¨

### 1. messages è¡¨ï¼ˆæ¶ˆæ¯è¡¨ï¼‰

**è¡¨ç»“æ„**ï¼š
- `id`: è‡ªå¢ID
- `message_id`: æ¶ˆæ¯å”¯ä¸€IDï¼ˆUUIDï¼‰
- `conversation_id`: ä¼šè¯ID
- `sender_id`: å‘é€è€…ç”¨æˆ·ID
- `receiver_id`: æ¥æ”¶è€…ç”¨æˆ·ID
- `content`: æ¶ˆæ¯å†…å®¹
- `message_type`: æ¶ˆæ¯ç±»å‹ï¼ˆTEXT, IMAGEç­‰ï¼‰
- `timestamp`: æ—¶é—´æˆ³
- `status`: çŠ¶æ€ï¼ˆSENT, DELIVERED, READç­‰ï¼‰
- `is_recalled`: æ˜¯å¦å·²æ’¤å›
- `created_at`: åˆ›å»ºæ—¶é—´

### 2. conversations è¡¨ï¼ˆä¼šè¯è¡¨ï¼‰

**è¡¨ç»“æ„**ï¼š
- `conversation_id`: ä¼šè¯ID
- `type`: ç±»å‹ï¼ˆSINGLEå•èŠï¼ŒGROUPç¾¤èŠï¼‰
- `target_id`: å¯¹æ–¹ç”¨æˆ·ID
- `last_message`: æœ€åä¸€æ¡æ¶ˆæ¯
- `last_message_time`: æœ€åæ¶ˆæ¯æ—¶é—´
- `unread_count`: æœªè¯»æ¶ˆæ¯æ•°

---

## ğŸ” æŸ¥è¯¢å‘½ä»¤

### 1. æŸ¥è¯¢æœ€è¿‘çš„æ¶ˆæ¯

```bash
# SSHç™»å½•æœåŠ¡å™¨
ssh root@47.116.197.230

# è¿›å…¥MySQL
mysql -h localhost -u wangjia -pqazQAZ123 tongxun

# æŸ¥è¯¢æœ€è¿‘10æ¡æ¶ˆæ¯
SELECT 
    message_id,
    conversation_id,
    sender_id,
    receiver_id,
    content,
    message_type,
    FROM_UNIXTIME(timestamp/1000) as send_time,
    status,
    created_at
FROM messages
ORDER BY timestamp DESC
LIMIT 10;
```

### 2. æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„æ¶ˆæ¯

```sql
-- æŸ¥è¯¢å‘é€ç»™æŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆreceiverId = '406a3cd2-6137-4c1a-bd0b-37008507093d'ï¼‰
SELECT 
    message_id,
    conversation_id,
    sender_id,
    receiver_id,
    content,
    message_type,
    FROM_UNIXTIME(timestamp/1000) as send_time,
    status,
    created_at
FROM messages
WHERE receiver_id = '406a3cd2-6137-4c1a-bd0b-37008507093d'
ORDER BY timestamp DESC
LIMIT 20;

-- æŸ¥è¯¢æŒ‡å®šä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯
SELECT 
    message_id,
    sender_id,
    receiver_id,
    content,
    FROM_UNIXTIME(timestamp/1000) as send_time,
    status
FROM messages
WHERE conversation_id = '406a3cd2-6137-4c1a-bd0b-37008507093d_9849a625-dece-49aa-ab30-bdb4b57fd231'
ORDER BY timestamp ASC;
```

### 3. æŸ¥è¯¢æœªé€è¾¾çš„æ¶ˆæ¯

```sql
-- æŸ¥è¯¢çŠ¶æ€ä¸ºSENTä½†æ¥æ”¶è€…å¯èƒ½ä¸åœ¨çº¿çš„æ¶ˆæ¯
SELECT 
    m.message_id,
    m.receiver_id,
    m.content,
    FROM_UNIXTIME(m.timestamp/1000) as send_time,
    u.nickname as receiver_name
FROM messages m
LEFT JOIN users u ON m.receiver_id = u.user_id
WHERE m.status = 'SENT'
AND m.timestamp > UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 24 HOUR)) * 1000
ORDER BY m.timestamp DESC;
```

### 4. æŸ¥è¯¢ä¼šè¯ä¿¡æ¯

```sql
-- æŸ¥è¯¢æ‰€æœ‰ä¼šè¯
SELECT 
    conversation_id,
    type,
    target_id,
    target_name,
    last_message,
    FROM_UNIXTIME(last_message_time/1000) as last_time,
    unread_count
FROM conversations
ORDER BY last_message_time DESC;

-- æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„ä¼šè¯
SELECT 
    conversation_id,
    type,
    target_id,
    target_name,
    last_message,
    FROM_UNIXTIME(last_message_time/1000) as last_time,
    unread_count
FROM conversations
WHERE conversation_id LIKE '%9849a625-dece-49aa-ab30-bdb4b57fd231%'
ORDER BY last_message_time DESC;
```

---

## ğŸ” æ¨é€é—®é¢˜æ’æŸ¥

### æ­¥éª¤1ï¼šæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²ä¿å­˜åˆ°æ•°æ®åº“

```bash
# ä½¿ç”¨ä½ çš„messageIdæŸ¥è¯¢
mysql -h localhost -u wangjia -pqazQAZ123 -e "
SELECT 
    message_id,
    sender_id,
    receiver_id,
    content,
    FROM_UNIXTIME(timestamp/1000) as send_time,
    status
FROM tongxun.messages
WHERE message_id = '20e7150a-2b39-491a-9e10-e845f71e0128';
"
```

### æ­¥éª¤2ï¼šæ£€æŸ¥æ¥æ”¶è€…æ˜¯å¦åœ¨çº¿ï¼ˆæŸ¥çœ‹Redisï¼‰

```bash
# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨çº¿
redis-cli

# åœ¨Redisä¸­æŸ¥è¯¢ç”¨æˆ·çš„socketè¿æ¥
KEYS user:online:*

# æŸ¥è¯¢æŒ‡å®šç”¨æˆ·æ˜¯å¦åœ¨çº¿
GET user:online:406a3cd2-6137-4c1a-bd0b-37008507093d

# æŸ¥è¯¢ç”¨æˆ·çš„socketè¿æ¥åˆ—è¡¨
SMEMBERS user:sockets:406a3cd2-6137-4c1a-bd0b-37008507093d
```

### æ­¥éª¤3ï¼šæŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

```bash
# æŸ¥çœ‹PM2æ—¥å¿—
pm2 logs tongxun-server --lines 100

# æˆ–è€…æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f /var/www/tongxun/server/logs/combined.log | grep -E "å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·|æ¶ˆæ¯å·²å‘é€|ç”¨æˆ·.*ç¦»çº¿"

# æŸ¥çœ‹æŒ‡å®šç”¨æˆ·çš„æ¶ˆæ¯æ¨é€æ—¥å¿—
tail -f /var/www/tongxun/server/logs/combined.log | grep "406a3cd2-6137-4c1a-bd0b-37008507093d"
```

### æ­¥éª¤4ï¼šæ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€

åœ¨æ—¥å¿—ä¸­æŸ¥æ‰¾ï¼š
- `ç”¨æˆ· ${userId} è¿æ¥WebSocket` - ç”¨æˆ·è¿æ¥æˆåŠŸ
- `å‘é€æ¶ˆæ¯ç»™ç”¨æˆ· - userId` - æ­£åœ¨å°è¯•æ¨é€
- `æ¶ˆæ¯å·²å‘é€ - userId` - æ¨é€æˆåŠŸ
- `ç”¨æˆ· ${userId} ç¦»çº¿` - ç”¨æˆ·ä¸åœ¨çº¿

---

## ğŸ› å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šæ¶ˆæ¯å·²ä¿å­˜ï¼Œä½†æ¥æ”¶è€…æ”¶ä¸åˆ°

**å¯èƒ½åŸå› **ï¼š
1. æ¥æ”¶è€…æœªè¿æ¥WebSocket
2. Socketè¿æ¥å·²æ–­å¼€
3. æ¥æ”¶è€…userIdé”™è¯¯

**æ’æŸ¥**ï¼š
```sql
-- æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æ­£ç¡®ä¿å­˜
SELECT * FROM messages WHERE message_id = 'your-message-id';

-- æ£€æŸ¥æ¥æ”¶è€…IDæ˜¯å¦æ­£ç¡®
SELECT user_id, nickname, phone_number FROM users WHERE user_id = 'receiver-id';
```

```bash
# æ£€æŸ¥æ¥æ”¶è€…æ˜¯å¦åœ¨çº¿
redis-cli GET user:online:receiver-id
```

### é—®é¢˜2ï¼šæ¥æ”¶è€…åœ¨çº¿ä½†æ”¶ä¸åˆ°æ¶ˆæ¯

**æ’æŸ¥**ï¼š
1. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦è°ƒç”¨äº† `sendToUser`
2. æ£€æŸ¥socketè¿æ¥æ˜¯å¦æœ‰æ•ˆ
3. æ£€æŸ¥Redisä¸­çš„socketè¿æ¥ä¿¡æ¯æ˜¯å¦ä¸å†…å­˜åŒæ­¥

```bash
# æŸ¥çœ‹æ¨é€æ—¥å¿—
pm2 logs tongxun-server | grep "å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·"
```

### é—®é¢˜3ï¼šæ¶ˆæ¯çŠ¶æ€ä¸€ç›´æ˜¯SENT

**è¯´æ˜**ï¼š
- å¦‚æœæ¥æ”¶è€…åœ¨çº¿ï¼Œæ¶ˆæ¯ä¼šé€šè¿‡WebSocketæ¨é€
- å¦‚æœæ¥æ”¶è€…ç¦»çº¿ï¼Œæ¶ˆæ¯å·²ä¿å­˜åœ¨æ•°æ®åº“ï¼Œä¸‹æ¬¡ç™»å½•æ—¶ä¼šé€šè¿‡ `/api/messages/offline` è·å–

**æ£€æŸ¥ç¦»çº¿æ¶ˆæ¯API**ï¼š
```bash
# æµ‹è¯•è·å–ç¦»çº¿æ¶ˆæ¯ï¼ˆéœ€è¦æœ‰æ•ˆçš„tokenï¼‰
curl -X GET "http://47.116.197.230:3000/api/messages/offline?lastMessageTime=0" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## ğŸ“‹ å¿«é€Ÿæ£€æŸ¥æ¸…å•

### æ¶ˆæ¯å‘é€åæ£€æŸ¥ï¼š

1. âœ… **æ¶ˆæ¯æ˜¯å¦ä¿å­˜åˆ°æ•°æ®åº“**
   ```sql
   SELECT * FROM messages WHERE message_id = 'message-id';
   ```

2. âœ… **æ¥æ”¶è€…æ˜¯å¦åœ¨çº¿**
   ```bash
   redis-cli GET user:online:receiver-id
   ```

3. âœ… **WebSocketæ¨é€æ˜¯å¦æˆåŠŸ**
   ```bash
   pm2 logs tongxun-server | grep "æ¶ˆæ¯å·²å‘é€ - userId: receiver-id"
   ```

4. âœ… **æ¥æ”¶è€…æ˜¯å¦èƒ½è·å–ç¦»çº¿æ¶ˆæ¯**
   - æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦æ­£ç¡®è°ƒç”¨ `/api/messages/offline`
   - æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦ç›‘å¬WebSocketçš„ `message` äº‹ä»¶

---

## ğŸ”§ è°ƒè¯•å‘½ä»¤ï¼ˆä¸€è¡Œæ‰§è¡Œï¼‰

```bash
# æŸ¥è¯¢æœ€è¿‘å‘é€çš„æ¶ˆæ¯åŠå…¶çŠ¶æ€
mysql -h localhost -u wangjia -pqazQAZ123 tongxun -e "
SELECT 
    message_id,
    sender_id,
    receiver_id,
    LEFT(content, 20) as content_preview,
    FROM_UNIXTIME(timestamp/1000) as send_time,
    status
FROM messages
ORDER BY timestamp DESC
LIMIT 5;
"

# æ£€æŸ¥ç”¨æˆ·åœ¨çº¿çŠ¶æ€
redis-cli GET user:online:406a3cd2-6137-4c1a-bd0b-37008507093d

# æŸ¥çœ‹æœ€è¿‘çš„æ¶ˆæ¯æ¨é€æ—¥å¿—
pm2 logs tongxun-server --lines 50 | grep -E "å‘é€æ¶ˆæ¯|æ¶ˆæ¯å·²å‘é€|ç¦»çº¿"
```

---

## ğŸ“ æ¶ˆæ¯æ¨é€æµç¨‹

1. **å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯** â†’ WebSocket `message` äº‹ä»¶
2. **æœåŠ¡å™¨æ¥æ”¶** â†’ `handleMessage()` å‡½æ•°
3. **ä¿å­˜åˆ°æ•°æ®åº“** â†’ `messages` è¡¨
4. **æ›´æ–°ä¼šè¯** â†’ `conversations` è¡¨
5. **æ¨é€ç»™æ¥æ”¶è€…** â†’ `sendToUser()` å‡½æ•°
   - å¦‚æœåœ¨çº¿ï¼šé€šè¿‡WebSocketå®æ—¶æ¨é€
   - å¦‚æœç¦»çº¿ï¼šæ¶ˆæ¯å·²ä¿å­˜ï¼Œç­‰å¾…ä¸‹æ¬¡ç™»å½•æ—¶è·å–

---

## ğŸ’¡ å…³é”®ä»£ç ä½ç½®

- **æ¶ˆæ¯å¤„ç†**: `server/src/websocket/socketHandler.js` - `handleMessage()` å‡½æ•°ï¼ˆç¬¬104è¡Œï¼‰
- **æ¶ˆæ¯æ¨é€**: `server/src/websocket/socketHandler.js` - `sendToUser()` å‡½æ•°ï¼ˆç¬¬265è¡Œï¼‰
- **ç¦»çº¿æ¶ˆæ¯API**: `server/src/routes/message.js` - `/offline` è·¯ç”±ï¼ˆç¬¬149è¡Œï¼‰


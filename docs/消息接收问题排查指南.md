# 消息接收问题排查指南

## 🔍 问题描述
接收方收不到消息，需要排查消息发送和接收的完整流程。

## 📋 排查步骤

### 1. 检查服务端日志（最重要）

**SSH登录服务器查看日志：**

```bash
# SSH登录
ssh root@47.116.197.230

# 查看PM2日志
pm2 logs

# 或查看日志文件
tail -f /var/www/tongxun/server/logs/combined.log
```

**关键日志点：**
- `发送消息给用户 - userId: xxx, event: message` - 服务端尝试发送消息
- `消息已发送 - userId: xxx, socketId: xxx` - 消息发送成功
- `用户 xxx 离线，无法发送实时通知` - 接收者未连接
- `所有连接都失败 - userId: xxx` - 所有连接都失败

### 2. 检查客户端日志

**在 Android Studio Logcat 中查看：**

**发送方日志：**
- `已发送消息到服务器 - messageId=xxx` - 消息已发送
- `收到消息发送确认` - 服务器确认收到

**接收方日志：**
- `收到message事件 - data: {...}` - 收到消息事件
- `解析消息成功 - messageId=xxx` - 消息解析成功
- `收到消息通知 - messageId=xxx` - MainViewModel收到通知
- `消息已保存到本地数据库 - messageId=xxx` - 消息已保存

### 3. 可能的问题和解决方案

#### 问题1：接收者未连接 WebSocket

**症状：**
- 服务端日志显示：`用户 xxx 离线，无法发送实时通知`

**解决方案：**
- 确保接收者已登录并打开应用
- 检查接收者的 WebSocket 连接状态
- 查看接收者 Logcat 是否有 `WebSocket连接成功` 日志

#### 问题2：服务端找不到接收者的连接

**症状：**
- 服务端日志显示：`在线连接数: 0`
- 服务端日志显示：`所有连接都失败`

**可能原因：**
- 接收者的 userId 不正确
- 接收者的 WebSocket 连接已断开
- Redis 中的连接信息过期

**解决方案：**
- 检查发送消息时使用的 `receiverId` 是否正确
- 检查接收者是否真的在线
- 重启服务端（清理连接缓存）

#### 问题3：客户端未监听消息事件

**症状：**
- 服务端日志显示消息已发送
- 但客户端没有收到消息

**检查点：**
- 确认 MainViewModel 已初始化
- 确认 WebSocket 连接成功
- 查看 Logcat 是否有 `收到message事件` 日志

#### 问题4：消息格式不匹配

**症状：**
- 客户端收到消息但解析失败
- Logcat 显示：`解析消息失败`

**检查点：**
- 服务端发送的消息格式是否正确
- 客户端解析逻辑是否正确

### 4. 测试步骤

#### 测试1：发送消息并查看服务端日志

1. **发送方**：发送一条消息
2. **查看服务端日志**：
   ```bash
   pm2 logs | grep "发送消息给用户"
   ```
3. **检查**：
   - 是否看到 `发送消息给用户 - userId: [接收者ID]`
   - 是否看到 `消息已发送` 或 `用户离线`

#### 测试2：检查接收方连接状态

1. **接收方**：查看 Logcat
2. **搜索**：`WebSocket连接成功`
3. **确认**：连接是否成功

#### 测试3：检查消息接收

1. **接收方**：查看 Logcat
2. **搜索**：`收到message事件`
3. **确认**：是否收到消息事件

### 5. 添加调试日志

如果问题仍然存在，需要添加更详细的日志：

**服务端（已有很多日志）：**
- `socketHandler.js` 中的 `sendToUser` 函数已有详细日志

**客户端（需要添加）：**
- 在 `WebSocketManager.kt` 的 `on("message")` 中添加日志
- 在 `MainViewModel.kt` 的 `MessageReceived` 处理中添加日志

### 6. 常见问题检查清单

- [ ] 接收者是否已登录？
- [ ] 接收者的 WebSocket 是否已连接？
- [ ] 发送消息时使用的 `receiverId` 是否正确？
- [ ] 服务端日志是否显示消息已发送？
- [ ] 客户端是否收到 `message` 事件？
- [ ] 消息格式是否正确？
- [ ] MainViewModel 是否已初始化？
- [ ] 是否有错误日志？

### 7. 快速诊断命令

```bash
# 1. 查看服务端实时日志
ssh root@47.116.197.230
pm2 logs --lines 100

# 2. 查看最近的错误
pm2 logs --err --lines 50

# 3. 检查服务状态
pm2 status

# 4. 重启服务（如果需要）
pm2 restart all
```

## 🎯 下一步

1. **先查看服务端日志**，确认消息是否真的发送了
2. **再查看客户端日志**，确认是否收到了消息
3. **根据日志定位问题**，然后针对性解决


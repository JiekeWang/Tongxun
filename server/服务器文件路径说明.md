# 服务器文件路径说明

## 服务器部署路径

根据 `start-server.sh` 脚本，服务器部署在以下路径：

**服务器根目录：** `/var/www/tongxun/server`

## 重要文件路径

### 1. WebSocket 处理文件
**文件路径：** `/var/www/tongxun/server/src/websocket/socketHandler.js`

**说明：** 
- 这是 WebSocket 消息处理的核心文件
- 负责处理实时消息发送、接收、好友请求等 WebSocket 事件
- 在 `src/index.js` 中通过 `require('./websocket/socketHandler')` 引入

**修改后需要：**
- 重启 PM2 服务：`pm2 restart tongxun-server`
- 或使用：`cd /var/www/tongxun/server && pm2 restart tongxun-server`

### 2. 服务器入口文件
**文件路径：** `/var/www/tongxun/server/src/index.js`

**说明：**
- 服务器主入口文件
- 启动 Express 服务器和 Socket.IO
- 引入并初始化 WebSocket 处理

### 3. 其他重要文件路径

| 文件 | 服务器路径 | 说明 |
|------|-----------|------|
| 路由文件 | `/var/www/tongxun/server/src/routes/` | API 路由处理 |
| 配置文件 | `/var/www/tongxun/server/src/config/` | 数据库、Redis 配置 |
| 中间件 | `/var/www/tongxun/server/src/middleware/` | 认证等中间件 |
| 环境配置 | `/var/www/tongxun/server/.env` | 环境变量配置 |
| PM2 配置 | `/var/www/tongxun/server/ecosystem.config.js` | PM2 进程管理配置 |
| 日志目录 | `/var/www/tongxun/server/logs/` | 服务器日志 |

## 文件结构

```
/var/www/tongxun/server/
├── src/
│   ├── index.js                    # 服务器入口文件
│   ├── websocket/
│   │   └── socketHandler.js        # ⭐ WebSocket 处理文件（消息延迟优化）
│   ├── routes/                     # API 路由
│   ├── config/                     # 配置文件
│   ├── middleware/                  # 中间件
│   └── utils/                       # 工具函数
├── .env                            # 环境变量
├── ecosystem.config.js             # PM2 配置
├── package.json                    # 依赖配置
└── logs/                           # 日志目录
```

## 修改文件后的操作步骤

### 修改 `socketHandler.js` 后：

1. **上传文件到服务器：**
   ```bash
   # 使用 scp 上传（从本地）
   scp server/src/websocket/socketHandler.js user@server:/var/www/tongxun/server/src/websocket/
   ```

2. **重启服务：**
   ```bash
   # SSH 登录服务器后执行
   cd /var/www/tongxun/server
   pm2 restart tongxun-server
   ```

3. **查看日志确认：**
   ```bash
   pm2 logs tongxun-server
   ```

## 注意事项

1. **文件权限：** 确保文件有正确的读写权限
2. **备份：** 修改前建议备份原文件
3. **测试：** 修改后先在测试环境验证
4. **日志：** 修改后查看日志确认服务正常启动

## 快速命令参考

```bash
# 进入服务器目录
cd /var/www/tongxun/server

# 查看服务状态
pm2 list

# 查看实时日志
pm2 logs tongxun-server

# 重启服务
pm2 restart tongxun-server

# 停止服务
pm2 stop tongxun-server

# 启动服务
pm2 start ecosystem.config.js
```

